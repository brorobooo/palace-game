<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ·±å®«åç« ï¼šå‡¤æƒå¼ˆçˆ±</title>

<!-- âœ… å…³é”®ï¼šç§»åŠ¨ç«¯é€‚é… -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
html, body {
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
}

:root {
    font-size: 16px;
    --palace-red: #8b1b1b;
    --gold: #c5a059;
    --paper: #f4f1de;
    --ink: #2c2c2c;
    --success-bg: #fffafa;
}

* {
    box-sizing: border-box;
}

body {
    margin: 0;
    background: #1a1a1a;
    font-family: "STKaiti", "KaiTi", serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100dvh;
    user-select: none;
    -webkit-user-select: none;
    touch-action: manipulation;
}

#game-container {
    width: 100vw;
    max-width: 500px;
    margin: 0 auto;
    overflow: hidden;
    height: 100%;
    background: var(--paper) url("https://www.transparenttextures.com/patterns/paper-fibers.png");
    border: 0.4rem solid var(--palace-red);
    outline: 0.15rem solid var(--gold);
    outline-offset: -0.25rem;
    display: flex;
    flex-direction: column;
    position: relative;
    box-shadow: 0 1rem 2.5rem rgba(0,0,0,.7);
}

/* ===== Header ===== */
header {
    background: var(--palace-red);
    color: var(--gold);
    text-align: center;
    padding: 0.8rem 0;
    font-size: 1.2rem;
    letter-spacing: 0.3rem;
    border-bottom: 0.2rem double var(--gold);
    font-weight: bold;
}

/* ===== Scene ===== */
#scene {
    flex: 1;
    padding: 1.2rem;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

/* ===== Start Page ===== */
#page-start {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
}

#page-start h1 {
    font-size: 2rem;
    color: var(--palace-red);
    letter-spacing: 0.6rem;
    margin-bottom: 2rem;
}

input[type="text"] {
    width: 80%;
    font-size: 1.1rem;
    padding: 0.6rem;
    border: none;
    border-bottom: 0.15rem solid var(--palace-red);
    text-align: center;
    background: transparent;
    outline: none;
}

/* ===== Common UI ===== */
.message {
    background: rgba(255,255,255,.75);
    border: 0.1rem solid var(--gold);
    padding: 1rem;
    line-height: 1.7;
    font-size: 1rem;
    margin-bottom: 1rem;
    color: var(--ink);
}

.choice-btn {
    width: 100%;
    padding: 0.7rem;
    margin-bottom: 0.6rem;
    font-size: 1rem;
    border: 0.1rem solid var(--palace-red);
    background: #fff;
    color: var(--palace-red);
    cursor: pointer;
    box-shadow: 0.15rem 0.15rem 0 var(--gold);
    transition: 0.15s;
}

.choice-btn:hover {
    background: var(--palace-red);
    color: var(--gold);
}

.choice-btn:active {
    transform: scale(0.97);
}
#stat-panel {
    position: fixed;
    top: 0;
    right: 0;
    width: 85vw;
    max-width: 420px;
    height: 100vh;
    transform: translateX(100%);
    transition: transform 0.35s ease;
    background: rgba(30, 30, 30, 0.98); color: #ddd;
    z-index: 1000;
}
 
#stat-panel.open {
    transform: translateX(0);
}


#stat-panel h3 { color: var(--gold); margin: 0 0 15px 0; border-bottom: 1px solid var(--gold); padding-bottom: 5px; }
#stat-panel h4 { color: var(--gold); margin: 10px 0 5px 0; font-size: 0.95rem; }

/* ä¿®æ­£å°ç¯ç¬¼æ ·å¼ï¼šç¡®ä¿å®ƒåœ¨å±‚çº§æœ€ä¸Šæ–¹ */
#menu-trigger { 
    position: absolute; 
    bottom: 20px; 
    right: 20px; 
    width: 50px; 
    height: 50px; 
    background: var(--gold); 
    border-radius: 50%; 
    display: flex; /* é»˜è®¤è®¾ä¸º flexï¼Œä½†å— hidden ç±»æ§åˆ¶ */
    justify-content: center; 
    align-items: center; 
    cursor: pointer; 
    font-size: 24px; 
    border: 2px solid white; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.4); 
    z-index: 101; 
}

.hidden { display: none !important; }

.stat-group { 
    background: rgba(255,255,255,0.05); 
    padding: 8px 12px; 
    margin-bottom: 10px; 
    border-radius: 4px;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
}
    /* éŸ³é‡è°ƒèŠ‚ï¼šå¯¹é½æ’ç‰ˆ */
.volume-ctrl { 
    display: flex; 
    align-items: center; 
    justify-content: space-between;
    gap: 10px; 
    margin: 5px 0;
}
.end-card {
    margin: auto;
    padding: 30px 20px;
    background: #fffafa;
    border: 4px double var(--palace-red);
    box-shadow: 0 0 25px rgba(0,0,0,0.5);
    text-align: center;
    max-width: 90%;
}
.volume-ctrl label { font-size: 0.85rem; color: #bbb; white-space: nowrap; width: 50px; }
.volume-ctrl input[type="range"] { 
    flex: 1; 
    height: 4px;
    accent-color: var(--gold);
}

/* ===== Mobile ===== */
@media (max-width: 600px) {
    :root { font-size: 15px; }
    #scene { padding: 0.8rem; }
    header { font-size: 1rem; }
}

/* ===== Tablet Landscape ===== */
@media (min-width: 768px) and (orientation: landscape) {
    #game-container { max-width: 420px; }
}
/* ===== æ¸¸æˆå†…å¼¹çª— ===== */
.popup {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.popup-box {
    background: #fffafa;
    border: 4px double var(--palace-red);
    padding: 25px 20px;
    width: 85%;
    max-width: 380px;
    text-align: center;
    box-shadow: 0 0 25px rgba(0,0,0,0.6);
    animation: popupIn 0.3s ease;
}

.popup-box h2 {
    color: var(--palace-red);
    margin: 0 0 15px;
    letter-spacing: 4px;
}

.popup-box div {
    line-height: 1.8;
    color: var(--ink);
    margin-bottom: 20px;
}

.popup-btn {
    background: var(--palace-red);
    color: var(--gold);
}

@keyframes popupIn {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}
.popup-mask {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.75);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.popup-mask.hidden {
    display: none;
}

.game-popup {
    width: 85%;
    max-width: 360px;
    background: #fff7f2;
    border: 2px solid #8b1e1e;
    border-radius: 10px;
    padding: 18px;
    text-align: center;
    box-shadow: 0 0 20px rgba(0,0,0,0.6);
}

.popup-title {
    font-size: 20px;
    font-weight: bold;
    color: #8b1e1e;
    margin-bottom: 10px;
}

.popup-content {
    font-size: 15px;
    line-height: 1.6;
    color: #333;
    margin-bottom: 16px;
}

.popup-btn {
    width: 100%;
    padding: 10px 0;
    background: #8b1e1e;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 16px;
}


</style>
</head>

<body>

<div id="game-container">
    <div id="loading-overlay"><div id="load-status">è½½å…¥å¤§å…¸ä¸­...</div></div>
    <header>æ·±å®«åç« ï¼šå‡¤æƒå¼ˆ</header>
    
    <div id="stat-panel">
    <h3 style="text-align:center; color:var(--gold); margin-top:0;">ä¸ªäººæ¡£ç±</h3>
    <div id="stat-content"></div>
    
    <div class="stat-group">
        <h4>ä¹éŸ³è°ƒèŠ‚</h4>
        <div class="volume-ctrl">
            <label>èƒŒæ™¯éŸ³</label>
            <input type="range" id="bgm-vol" min="0" max="1" step="0.1" value="0.5" oninput="adjustVolume()">
        </div>
        <div class="volume-ctrl">
            <label>éŸ³æ•ˆ</label>
            <input type="range" id="se-vol" min="0" max="1" step="0.1" value="0.7" oninput="adjustVolume()">
        </div>
    </div>

    <div class="stat-group" style="border:none; background:none; display:flex; gap:5px;">
        <button class="choice-btn" style="background:#4a0404; color:var(--gold); flex:1;" onclick="saveGame()">å­˜æ¡£</button>
        <button class="choice-btn" style="background:#042a04; color:var(--gold); flex:1;" onclick="loadGame()">è¯»æ¡£</button>
    </div>
    
    <button class="choice-btn" style="background:none; color:var(--gold); margin-top:10px;" onclick="toggleStats()">æ”¶å›å·è½´</button>
</div>

    <div id="menu-trigger" class="hidden" onclick="toggleStats()">ğŸ®</div>
    <div id="scene">
     <div id="page-start">
    <h1>æ·±å®«è¯é˜™</h1>
    <input type="text" id="p-name" placeholder="äºåå†Œç•™ä¸‹èŠ³å..." style="width: 80%; border: none; border-bottom: 2px solid var(--palace-red); background: transparent; text-align: center; margin-bottom: 30px; font-size: 1.2rem; outline: none;">
    <button class="choice-btn" style="width: 70%; font-size: 1.1rem;" onclick="generateIdentity()">æ±‚å–ç­¾æ–‡</button>
</div>

        <div id="page-identity" class="hidden">
            <div id="identity-content">
                <div class="message" style="text-align: center;" id="era-intro"></div>
                <div style="border: 2px solid var(--palace-red); padding: 15px; background: #fffafa; text-align: center; margin-bottom: 15px;">
                    <h2 id="display-rank" style="color: var(--palace-red); margin: 0;"></h2>
                    <div id="display-stats-preview" style="margin-top: 10px; text-align: left; display: inline-block; font-size: 0.95rem; line-height: 1.8;"></div>
                </div>
                <button class="choice-btn" onclick="enterPalace()">é¢†æ—¨å…¥å®«</button>
                <button class="choice-btn" style="background:#400; color:#fff;" onclick="resistDecree()">æŠ—æ—¨ä¸å°Š</button>
            </div>
        </div>

        <div id="page-game" class="hidden">
            <div id="story-text" class="message"></div>
            <div id="choices-area"></div>
        </div>
    </div>
</div>
    <!-- æ¸¸æˆå†…å¼¹çª— -->
<div id="game-popup" class="popup hidden">
    <div class="popup-box">
        <h2 id="popup-title"></h2>
        <div id="popup-text"></div>
        <button class="choice-btn popup-btn" onclick="closePopup()">è°¨éµåœ£æ„</button>
    </div>
</div>
<!-- æ¸¸æˆå†…å¼¹çª—ï¼šç”Ÿå­ / äº‹ä»¶æé†’ -->
<div id="game-popup-mask" class="popup-mask hidden">
  <div class="game-popup">
    <div class="popup-title" id="popup-title">å–œè®¯</div>
    <div class="popup-content" id="popup-content"></div>
    <button class="popup-btn" onclick="closeGamePopup()">è°¨éµåœ£æ„</button>
  </div>
</div>
<audio id="bgm-player" loop></audio>
<audio id="se-player"></audio>


<script>
    // --- è·¯å¾„é…ç½® ---
    const BASE_URL = 'https://raw.githubusercontent.com/brorobooo/palace-game/main/';
    const RANK_FILES = {
        "å®«å¥³": "story_maid.csv",
        "ç­”åº”": "story_lady.csv",
        "è´µäºº": "story_noble.csv",
        "å¦ƒ": "story_consort.csv",
        "è´µå¦ƒ": "story_noble_consort.csv",
        "çš‡å": "story_empress.csv"
    };

    let eraNames = ["æ˜­æ™¯", "æ°¸å®", "ç››å¹³", "å…ƒç¦§", "å˜‰ä½‘", "é–å’Œ", "å¤©æˆ", "æ‰¿å¾·", "æ™¯æœ”", "ä¸‡å®"];
    let emperor = { eraName: "", currentYear: 0, deathYear: 0 };
    let p = { name: "", rank: "", year: 1, quarter: 1, stats: {}, children: { male: 0, female: 0 }, pregTimer: -1 };
    let currentPool = [];
    let usedPlotIds = new Set(); 
    let lastWasDeadly = false; // æ­»å±€å†·å´æ§åˆ¶
    let pendingDeathReason = null; // ç”¨äºå»¶è¿Ÿæ­»äº¡ç»“ç®—


    // --- ç»“å±€æ•°æ®åº“ ---
   const ENDING_DB = {
        "ç­”åº”": { 
            son: [
                { title: "é•¿ä¿¡ç©ºç¯", text: "å…ˆå¸é©¾å´©ï¼Œæ–°å¸ç™»åŸºã€‚ä½ ä½ä»½ä½å¾®ï¼Œæ— ç¼˜å‰å¾€çš‡å­å°åœ°ã€‚æ–°å¸å¿µåŠå…„å¼Ÿæƒ…åˆ†ï¼Œå°†ä½ å®‰ç½®åœ¨çš‡å®¶åˆ«è‹‘ã€‚ä½ å°†æ‰€æœ‰å¸Œæœ›å¯„æ‰˜åœ¨çš‡å­èº«ä¸Šï¼Œä½™ç”Ÿåœ¨æ€å¿µä¸æœŸç›¼ä¸­åº¦è¿‡ã€‚" },
                { title: "å°åœ°é¢å…»", text: "ä½ çš„çš‡å­å—å°éƒ¡ç‹ï¼Œå¾—ä»¥å‰å¾€å°åœ°å°±è—©ã€‚ä½ éšå­å‰å¾€å°åœ°ï¼Œæˆä¸ºç‹åºœå¤ªå¦ƒã€‚è¿œç¦»å®«å»·çº·äº‰ï¼Œè™½æ— æ— ä¸ŠæƒåŠ¿ï¼Œå´æ‹¥æœ‰äº†å¯»å¸¸å¦‡äººçš„å®‰ç¨³ï¼Œå®‰äº«æ™šå¹´ã€‚" }
            ],
            daughter: [ { title: "åˆ«è‹‘æ™šé¦™", text: "è™½æ— çš‡å­åŠ å°ï¼Œä½†æ–°å¸å¿µä½ è‚²æœ‰å…¬ä¸»ï¼Œå…ä½ å®ˆé™µä¹‹è‹¦ï¼Œå°†ä½ å®‰ç½®åœ¨è¡Œå®«å…»è€ã€‚å…¬ä¸»æ—¶å¸¸å¥‰æ—¨æ¢æœ›ï¼Œå€’ä¹Ÿåœ¨æ¯å¥³æ¸©æƒ…ä¸­å¾—äº†ä¸€ä»½å®‰å®ã€‚" } ],
            none: [ { title: "é’ç¯ä¼´å†¢", text: "ä½œä¸ºæ— å® æ— å—£çš„ä½ä½å«”å¦ƒï¼Œä½ è¢«å®‰æ’å‰å¾€çš‡å®¶é™µå¯ï¼Œä¸ºå…ˆå¸å®ˆé™µã€‚é’ç¯å¤ä½›ï¼Œæ­¤ç”Ÿä¸ç¹åå®«å»·å½»åº•éš”ç»ã€‚" } ]
        },
        "è´µäºº": { 
            son: [
                { title: "é‡‘å°è£å½’", text: "ä½ çš„çš‡å­å¤©èµ„èªé¢–ï¼Œè·å°äº²ç‹ã€‚ä½ è¢«å°Šä¸ºçš‡å¤ªå¦ƒï¼Œäº«æœ‰ä¸°åšä¿¸ç¦„ã€‚çš‡å­æ—¶å¸¸å‰æ¥è¯·å®‰ï¼Œä½ åœ¨å°Šå´‡ä¸äº²æƒ…ä¸­ï¼Œå®‰åº¦å¯Œè´µæ™šå¹´ã€‚" },
                { title: "ç¦å®«ä½™æ¨", text: "ä½ çš„çš‡å­æ›¾å‚ä¸å¤ºå«¡æœ€ç»ˆè½è´¥ã€‚ä½ è¢«å‰¥å¤ºå°å·ï¼Œç¦è¶³åœ¨ååƒ»å®«æ®¿ï¼Œç»ˆç”Ÿä¸å¾—ä¸å­è§ï¼Œåœ¨æ‚”æ¨ä¸­è‹Ÿæ´»ã€‚" }
            ], 
            daughter: [ { title: "å’Œäº²ç¦»æ€¨", text: "ä½ è‚²æœ‰å…¬ä¸»ï¼Œæ–°å¸ä¸ºç¨³å›ºé‚¦äº¤å°†å…¶é€å¾€è¿œå«å’Œäº²ã€‚æ–°å¸æ„Ÿå¿µä½ çš„éšå¿ï¼ŒåŠ å°ä½ ä¸ºå«”ã€‚ä½ æ—¶å¸¸æœ›ç€å’Œäº²çš„æ–¹å‘ï¼Œä½™ç”Ÿåœ¨æ€å¿µä¸è£è€€ä¸­äº¤ç»‡ã€‚" } ], 
            none: [ { title: "æ¢µéŸ³æ´—å°˜", text: "ä½ ä¸»åŠ¨è¯·æ—¨å‰å¾€çš‡å®¶å¯ºé™¢ä¿®è¡Œã€‚æ¯æ—¥è¯µç»ç¤¼ä½›ï¼Œæ¸…å¿ƒå¯¡æ¬²ã€‚å®«ä¸­æŒ‰æ—¶é€æ¥ä»½ä¾‹ï¼Œä½ å®‰ç„¶åº¦è¿‡ä½™ç”Ÿã€‚" } ] 
        },
        "å¦ƒ": { 
            son: [
                { title: "ç å¸˜å‚æ”¿", text: "ä½ çš„çš‡å­æ˜¯æ–°å¸çš„å¾—åŠ›è‡‚è†€ã€‚ä½ è¢«å†Œå°ä¸ºçš‡è€ƒè´µå¦ƒï¼Œåœ°ä½ä»…æ¬¡äºå¤ªåã€‚åå®«ä¹‹ä¸­æ— äººæ•¢ä¸ä½ æŠ—è¡¡ï¼Œæƒå€¾ä¸€æ—¶ã€‚" },
                { title: "è—©ç‹è‡³å°Š", text: "ä½ çš„çš‡å­å—å°äº²ç‹ã€‚ä½ å‰å¾€å°åœ°æˆä¸ºæœ€å°Šè´µçš„å¤ªå¦ƒã€‚çš‡å­å­é¡ºï¼Œå°½äº«è£åå¯Œè´µï¼Œå¯¿ç»ˆæ­£å¯ã€‚" }
            ], 
            daughter: [ { title: "åé˜³æ™šç¦", text: "è™½æ— çš‡å­ï¼Œä½†ä½ çš„å…¬ä¸»çš†å«å…¥åé—¨ã€‚æ–°å¸ç¤¼é‡åŠŸè‡£ï¼Œå°Šä½ ä¸ºå¤ªå¦ƒã€‚æ¯é€¢ä½³èŠ‚ï¼Œå¥³å„¿å¥³å©¿å…¥å®«è§è§ï¼Œä¹Ÿç®—äº«å°½å¤©ä¼¦ä¹‹ä¹ã€‚" } ],
            none: [ { title: "å¾·æœ›é•¿è€…", text: "ä½ ä¸€ç”Ÿè´¤è‰¯æ·‘å¾·ã€‚è™½æ— å­å—£ï¼Œæ–°å¸ä¾æ—§å°Šä½ ä¸ºçš‡å¤ªå¦ƒã€‚å®‰äº«æ¸…ç¦ï¼Œæˆä¸ºåå®«ä¸­å—äººæ•¬é‡çš„é•¿è€…ã€‚" } ]
        },
        "è´µå¦ƒ": { 
            son: [
                { title: "æ…ˆå®å¤•ç…§", text: "ä½ çš„å„¿å­ç™»åŸºä¸ºå¸ã€‚ä½ æ¯å‡­å­è´µè¢«å°Šä¸ºçš‡å¤ªåï¼Œå…¥ä½æ…ˆå®å®«ã€‚æ‰‹æ¡åå®«å¤§æƒï¼Œæˆä¸ºäº†å¤©ä¸‹æœ€å°Šè´µçš„å¥³äººã€‚" },
                { title: "æƒç•¥æ˜¥ç§‹", text: "æ–°å¸å¹´å¹¼ï¼Œä½ ä½œä¸ºçš‡å­ç”Ÿæ¯è”åˆæœè‡£è¾…æ”¿ã€‚è™½æ— å¤ªåä¹‹åï¼Œå´æœ‰å¤ªåä¹‹å®ï¼Œä¸€ç”Ÿåœ¨ç‹æœæƒåŠ›ä¸­å¿ƒå‘¨æ—‹ã€‚" }
            ], 
            daughter: [ { title: "é•¿å®å°Šå…»", text: "ä½œä¸ºå…ˆå¸è´µå¦ƒï¼Œä½ è™½åªæœ‰å…¬ä¸»ï¼Œä½†æ–°å¸ä»å°Šä½ ä¸ºçš‡è€ƒè´µå¦ƒã€‚ä½ åœ¨å®«ä¸­äº«æœ‰æé«˜è§„æ ¼å¾…é‡ï¼Œå¯Œè´µä¸€ç”Ÿã€‚" } ],
            none: [ { title: "åç•™å²ä¼ ", text: "ä½ èƒ½åŠ›å‡ºä¼—è¢«æ‰˜ä»˜è¾…ä½æ–°å¸ã€‚è™½æ— å­å—£å´æ·±å¾—ä¿¡ä»»ã€‚ååŠ©å¤ªåç¨³å®šå±€åŠ¿ï¼Œæˆä¸ºä¸€ä»£è´¤å¦ƒï¼Œåç•™é’å²ã€‚" } ]
        },
        "çš‡å": { 
            son: [
                { title: "æ¯ä»ªå¤©ä¸‹", text: "ä½ çš„å«¡å­ç»§ä½ã€‚ä½ åæ­£è¨€é¡ºå°Šä¸ºåœ£æ¯çš‡å¤ªåã€‚è¾…ä½æ–°å¸å¼€åˆ›ç››ä¸–ï¼Œæ­»åä¸å…ˆå¸åˆè‘¬ï¼Œäº«å°½å“€è£ã€‚" },
                { title: "å«¡æ¯å°Šä½", text: "æ–°å¸ä¸ºåº¶å­ï¼Œä½ ä¾æ—§ä»¥å«¡æ¯èº«ä»½å°Šä¸ºçš‡å¤ªåã€‚å‡­å€Ÿåœ°ä½ç¨³ååå®«å¤´æŠŠäº¤æ¤…ã€‚" }
            ], 
            daughter: [ { title: "é•¿ä¹å¤ªå", text: "å…ˆå¸é©¾å´©æ—¶ä½ ä»…è‚²æœ‰å…¬ä¸»ï¼Œä½†ä½œä¸ºæ­£å®«çš‡åï¼Œä½ è¢«å°Šä¸ºæ¯åçš‡å¤ªåã€‚å³ä¾¿æ–°å¸ç”Ÿæ¯åœ¨ä¸–ï¼Œä¹Ÿéœ€å‘ä½ è¡Œç¤¼ï¼Œè´µä¸å¯è¨€ã€‚" } ],
            none: [ { title: "ç»§åé•¿å°Š", text: "è™½æ— å­å—£ï¼Œä½†ä½œä¸ºæ­£å®«ï¼Œæ–°å¸ä¾æ—§å°Šä½ ä¸ºæ¯åçš‡å¤ªåã€‚ä½ ç¨³å±…åå®«ä¸»æŒå¤§å±€ï¼Œå®‰äº«æ— ä¸Šå°Šè£ã€‚" } ]
        }
    };


    window.onload = function() {
        document.getElementById('loading-overlay').classList.add('hidden');
    };

    // --- åŠ¨æ€åŠ è½½ä½åˆ†å‰§æƒ…åº“ ---
    async function loadRankStory(rank) {
        const fileName = RANK_FILES[rank];
        try {
            const response = await fetch(BASE_URL + fileName);
            const buffer = await response.arrayBuffer();
            const text = new TextDecoder('utf-8').decode(buffer);
            const rows = text.split(/\r?\n/).filter(line => line.trim() !== "");
            currentPool = rows.slice(1).map(row => {
                const cols = row.split(',');
                return {
                    id: cols[0], type: cols[1], title: cols[2], text: cols[3],
                    choices: [
                        { text: cols[4], attr: cols[5], val: parseInt(cols[6]), sText: cols[7], sEff: cols[8], fText: cols[9], fEff: cols[10] },
                        { text: cols[11], attr: cols[12], val: parseInt(cols[13]), sText: cols[14], sEff: cols[15], fText: cols[16], fEff: cols[17] }
                    ],
                    isBed: cols[18] ? cols[18].trim() : "0"
                };
            });
        } catch (err) { console.error("åŠ è½½å‰§æƒ…åº“å¤±è´¥:", err); }
    }

    // --- ä¸‡èƒ½å±æ€§è§£æé€»è¾‘ ---
    function applyEffect(effectStr, failMsg) {
    if (!effectStr || effectStr === "æ— ") return null;

    // 1. å¤„ç†ç›´æ¥æ­»äº¡å‰§æƒ…
    if (effectStr.includes("æ­»äº¡")) {
        return { isDead: true, reason: failMsg || "ä¸€æœèµ°é”™ï¼Œæ»¡ç›˜çš†è¾“ã€‚" };
    }

    const attrMap = {"å®¹è²Œ":"beauty", "å¿ƒæœº":"wit", "æ‰æƒ…":"talent", "ä½“è´¨":"body", "å£°æœ›":"prestige", "åœ£å® ":"favor"};
    effectStr.split(';').forEach(change => {
        let match = change.match(/([\u4e00-\u9fa5]+)([+-]\d+)/);
        if (match) {
            let attrName = attrMap[match[1]];
            if (attrName) p.stats[attrName] += parseInt(match[2]);
        }
    });

    // 2. å¤„ç†ä½“è´¨å½’é›¶æ­»äº¡
    if (p.stats.body <= 0) {
        p.stats.body = 0;
        updateStatPanel();
        return { isDead: true, reason: "ä½ é•¿å¹´ç´¯æœˆèº«å¤„æ·±å®«ï¼Œç»ˆç©¶æ˜¯è€—å°½äº†å¿ƒåŠ›ï¼Œæ’’æ‰‹äººå¯°ã€‚" };
    }

    updateStatPanel();
    return null; // æ²¡æ­»è¿”å›null
}

    function rnd(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    function generateIdentity() {
        playClick(); // éŸ³æ•ˆ
    switchBGM('start'); // å¯åŠ¨åˆå§‹éŸ³ä¹
        const nameInput = document.getElementById('p-name').value;
        if (!nameInput) return alert("è¯·åœ¨åå†Œä¸Šç•™ä¸‹èŠ³å");
        p.name = nameInput;
        emperor.eraName = eraNames[Math.floor(Math.random() * eraNames.length)];
        emperor.currentYear = rnd(1, 20); 
        emperor.deathYear = emperor.currentYear + rnd(15, 25); 
        const ranks = ["å®«å¥³", "ç­”åº”", "è´µäºº"];
        p.rank = ranks[Math.floor(Math.random() * 3)]; 
        const base = { "å®«å¥³":[45,80], "ç­”åº”":[80,120], "è´µäºº":[120,150] }[p.rank];
        p.stats = { beauty: rnd(base[0],base[1]), talent: rnd(base[0],base[1]), wit: rnd(base[0],base[1]), body: rnd(40,60), prestige: rnd(5,15), favor: p.rank === "å®«å¥³" ? 0 : rnd(1, 10) };
        
        document.getElementById('page-start').classList.add('hidden');
        document.getElementById('page-identity').classList.remove('hidden');
        document.getElementById('era-intro').innerHTML = `å½“ä»Šåœ£ä¸Šå¹´å·<b>ã€${emperor.eraName}ã€‘</b>ï¼Œå·²åœ¨ä½<b>${emperor.currentYear}</b>è½½ã€‚`;
        document.getElementById('display-rank').innerText = `${p.name} Â· ${p.rank}`;
        document.getElementById('display-stats-preview').innerHTML = `å®¹è²Œï¼š${p.stats.beauty} &nbsp; æ‰æƒ…ï¼š${p.stats.talent}<br>å¿ƒæœºï¼š${p.stats.wit} &nbsp; ä½“è´¨ï¼š${p.stats.body}<br>å£°æœ›ï¼š${p.stats.prestige} &nbsp; åœ£å® ï¼š${p.stats.favor}`;
    }

    // ä¿®æ”¹ 2: å…¥å®«å‡½æ•°ï¼ˆç¡®ä¿ç¯ç¬¼ç°èº«ï¼‰
async function enterPalace() {
    playClick();
    switchBGM('game'); // åˆ‡æ¢åˆ°æ¸¸æˆéŸ³ä¹
    await loadRankStory(p.rank);
    document.getElementById('page-identity').classList.add('hidden');
    document.getElementById('page-game').classList.remove('hidden');
    
    // æ˜¾ç¤ºå°ç¯ç¬¼å…¥å£
    document.getElementById('menu-trigger').classList.remove('hidden');
    
    // åˆ‡æ¢ BGM
    if (typeof switchBGM === "function") switchBGM('game'); 

    updateStatPanel();
    showPlot();
}



    // ç®€å•çš„åˆ‡æ¢å‡½æ•°
// ä¿®æ”¹ 1: å·è½´å¼€å…³
function toggleStats() {
    if (typeof playClick === "function") playClick(); // æ’­æ”¾éŸ³æ•ˆ
    const panel = document.getElementById('stat-panel');
    panel.classList.toggle('open');
}

    function updateStatPanel() {
        let status = p.pregTimer >= 0 ? "<span style='color:#ffb700'>æ€€æœ‰é¾™å—£</span>" : "å¹³å¸¸";
        document.getElementById('stat-content').innerHTML = `
            <div class="stat-group">
                <h4>å®«å»·èƒŒæ™¯</h4>
                <div class="stat-row"><span>å¹´å·</span><span class="stat-val">${emperor.eraName} ${emperor.currentYear}å¹´</span></div>
                <div class="stat-row"><span>å…¥å®«</span><span class="stat-val">ç¬¬${p.year}å¹´ ç¬¬${p.quarter}å­£</span></div>
            </div>
            <div class="stat-group">
                <h4>ä¸ªäººçŠ¶æ€</h4>
                <div class="stat-row"><span>ä½ä»½</span><span class="stat-val">${p.rank}</span></div>
                <div class="stat-row"><span>çŠ¶æ€</span><span class="stat-val">${status}</span></div>
                <div class="stat-row"><span>å­å—£</span><span class="stat-val">${p.children.male}çš‡å­ / ${p.children.female}å…¬ä¸»</span></div>
            </div>
            <div class="stat-group">
                <h4>å±æ€§æ•°å€¼</h4>
                <div class="stat-row"><span>å®¹è²Œ</span><span class="stat-val">${p.stats.beauty}</span></div>
                <div class="stat-row"><span>æ‰æƒ…</span><span class="stat-val">${p.stats.talent}</span></div>
                <div class="stat-row"><span>ä½“è´¨</span><span class="stat-val">${p.stats.body}</span></div>
                <div class="stat-row"><span>å¿ƒæœº</span><span class="stat-val">${p.stats.wit}</span></div>
                <div class="stat-row"><span>åœ£å® </span><span class="stat-val" style="color:#ff4d4d">${p.stats.favor}</span></div>
            </div>
        `;
    }
    function showPopup(title, text) {
    document.getElementById('popup-title').innerText = title;
    document.getElementById('popup-text').innerHTML = text;
    document.getElementById('game-popup').classList.remove('hidden');
}

function closePopup() {
    document.getElementById('game-popup').classList.add('hidden');
}

    // --- å­˜æ¡£åŠŸèƒ½ ---
function saveGame() {
    const saveData = {
        p: p,
        emperor: emperor,
        usedPlotIds: Array.from(usedPlotIds), // Set éœ€è¦è½¬æˆæ•°ç»„æ‰èƒ½ä¿å­˜
        lastWasDeadly: lastWasDeadly
    };
    localStorage.setItem('palace_game_save', JSON.stringify(saveData));
    alert("ã€ç³»ç»Ÿã€‘è¿›åº¦å·²å°å­˜äºå·è½´ï¼Œå¯éšæ—¶å›æº¯ã€‚");
}

    // ä¿®æ”¹ 3: å­˜æ¡£è¯»æ¡£åä¹Ÿè¦æ˜¾ç¤ºç¯ç¬¼
// --- è¯»æ¡£åŠŸèƒ½ ---
async function loadGame() {
    const savedRaw = localStorage.getItem('palace_game_save');
    document.getElementById('menu-trigger').classList.remove('hidden'); 
    if (!savedRaw) {
        alert("ã€æç¤ºã€‘å°šæ— å­˜æ¡£è®°å½•ï¼Œè¯·å…ˆå¼€å¯ä¸€æ®µäººç”Ÿã€‚");
        return;
    }
    
    const data = JSON.parse(savedRaw);
    
    // è¿˜åŸæ•°æ®
    p = data.p;
    emperor = data.emperor;
    usedPlotIds = new Set(data.usedPlotIds);
    lastWasDeadly = data.lastWasDeadly;

    // é‡æ–°åŠ è½½å¯¹åº”ä½åˆ†çš„å‰§æƒ…åº“
    await loadRankStory(p.rank);
    
    // åˆ‡æ¢ç•Œé¢å¹¶åˆ·æ–°æ˜¾ç¤º
    document.getElementById('page-start').classList.add('hidden');
    document.getElementById('page-identity').classList.add('hidden');
    document.getElementById('page-game').classList.remove('hidden');
    document.getElementById('menu-trigger').classList.remove('hidden');
    document.getElementById('stat-panel').classList.add('active');
    
    updateStatPanel();
    showPlot(); // ç»§ç»­ä¹‹å‰çš„å‰§æƒ…
    alert("ã€ç³»ç»Ÿã€‘æ—¶å…‰å›æº¯ï¼Œé‡è¿”å®«å»·ã€‚");
}

    function handlePregnancy() {
        if (p.pregTimer >= 0) return;
        let chance = p.stats.body > 200 ? 0.5 : 0.2;
        if (Math.random() < chance) {
    p.pregTimer = 0;
    showPopup(
        "å–œè®¯",
        "æ˜¨å¤œè’™å›å‚æ€œï¼Œä¼´é©¾è‰¯å®µã€‚<br>ä»Šæ™¨å¤ªåŒ»è¯·è„‰ï¼Œå·²ç„¶<strong>èº«æ€€é¾™è£”</strong>ï¼Œå¹¸æ‰¿å¤©æ©ã€‚"
    );
}

        updateStatPanel();
    }

    function giveBirth() {
        let roll = Math.random();
        if (roll < 0.05) { p.children.male++; p.children.female++; alert("è¯ä¸‹é¾™å‡¤åŒèƒèƒï¼"); }
        else if (roll < 0.5) { p.children.male++; alert("è¯ä¸‹äº†ä¸€ä½çš‡å­ï¼"); }
        else { p.children.female++; alert("è¯ä¸‹äº†ä¸€ä½å…¬ä¸»ï¼"); }
        p.pregTimer = -1;
        updateStatPanel();
    }

    function getDeathEnding() {
        if (p.rank === "å®«å¥³") return { title: "é‡è·è‡ªç”±", text: "çš‡ä¸Šé©¾å´©ï¼Œä½ ä½œä¸ºå‘å¾®å®«å¥³è¢«é£æ•£å‡ºå®«ï¼Œé‡è·è‡ªç”±ã€‚" };
        let pool = ENDING_DB[p.rank] || ENDING_DB["ç­”åº”"];
        let outcomes = p.children.male > 0 ? pool.son : (p.children.female > 0 ? pool.daughter : pool.none);
        let result = outcomes[Math.floor(Math.random() * outcomes.length)] || {title: "ç»ˆè€å®«ä¸­", text: "å²æœˆæµè½¬ï¼Œä½ æœ€ç»ˆåœ¨å®«å¢™å†…å¹³é™èµ°å®Œäº†ä¸€ç”Ÿã€‚"};
        return { title: result.title, text: result.text };
    }

    async function showPlot() {
        if (p.pregTimer >= 0) { p.pregTimer++; if (p.pregTimer >= 3) giveBirth(); }
        if (emperor.currentYear >= emperor.deathYear) { 
            let end = getDeathEnding();
            showEnding(end.title, end.text); return; 
        }

        // æ ¸å¿ƒä¿®æ”¹1: å®«å¥³å‡ºå®«å¹´é™æ”¹ä¸º10å¹´
        if (p.rank === "å®«å¥³" && p.year > 10) {
            showEnding("é‡è·è‡ªç”±", "ä½ åœ¨å®«ä¸­æœå½¹åè½½ï¼Œç»ˆè·æ©å…¸é£æ•£å‡ºå®«ã€‚"); return;
        }

        let available = currentPool.filter(s => !usedPlotIds.has(s.id));
        
        // æ ¸å¿ƒä¿®æ”¹2: æ­»å±€å†·å´é€»è¾‘ï¼Œé˜²æ­¢è¿ç»­é‡åˆ°æ­»äº¡åˆ¤å®š
        if (lastWasDeadly) {
            available = available.filter(s => 
                !s.choices[0].fEff.includes("æ­»äº¡") && !s.choices[1].fEff.includes("æ­»äº¡")
            );
        }

        if (available.length === 0) { usedPlotIds.clear(); available = currentPool; }
        let s = available[Math.floor(Math.random() * available.length)];
        usedPlotIds.add(s.id);

        // è®°å½•æœ¬å…³æ˜¯å¦ä¸ºæ­»å±€
        lastWasDeadly = (s.choices[0].fEff.includes("æ­»äº¡") || s.choices[1].fEff.includes("æ­»äº¡"));

        document.getElementById('story-text').innerHTML = `<strong>ã€${s.title}ã€‘</strong><br>${s.text}`;
        const area = document.getElementById('choices-area'); area.innerHTML = "";
        
        s.choices.forEach(c => {
            if(!c.text) return;
            let btn = document.createElement('button'); btn.className = "choice-btn"; btn.innerText = c.text;
            btn.onclick = async () => {
                playClick(); // åœ¨é€»è¾‘æœ€å‰é¢æ·»åŠ 
                const attrKeyMap = {"å®¹è²Œ":"beauty","æ‰æƒ…":"talent","å¿ƒæœº":"wit","ä½“è´¨":"body","å£°æœ›":"prestige","åœ£å® ":"favor"};
                let pass = (c.attr === "æ— " || p.stats[attrKeyMap[c.attr]] >= c.val);
                let resultText = pass ? c.sText : c.fText;
let effectStatus = applyEffect(pass ? c.sEff : c.fEff);

// å¦‚æœè§¦å‘æ­»äº¡ï¼Œä¸ç«‹åˆ»ç»“å±€ï¼Œå…ˆè®°ä¸‹æ¥
if (effectStatus && effectStatus.isDead) {
    pendingDeathReason = effectStatus.reason;
}



                if (pass && s.isBed === "1") handlePregnancy();

                // æ ¸å¿ƒä¿®æ”¹3: åœ£å® æ™‹å‡åˆ¤å®šé€»è¾‘ (ç­”åº”é—¨æ§›è°ƒè‡³100)
                let promotionMsg = "";
                const rankOrder = ["å®«å¥³", "ç­”åº”", "è´µäºº", "å¦ƒ", "è´µå¦ƒ", "çš‡å"];
                const rankReq = { "ç­”åº”": 100, "è´µäºº": 200, "å¦ƒ": 500, "è´µå¦ƒ": 1000, "çš‡å": 2500 };
                let nextRank = rankOrder[rankOrder.indexOf(p.rank) + 1];
                
                if (nextRank && p.stats.favor >= rankReq[nextRank]) {
                    p.rank = nextRank;
                    p.year = 1; p.quarter = 1;
                    usedPlotIds.clear();
                    await loadRankStory(p.rank); // è‡ªåŠ¨åˆ‡æ¢åˆ°æ–°ä½ä»½çš„å‰§æƒ…åº“
                    promotionMsg = `<br><b style="color:#8b1b1b">ã€æ™‹å‡ã€‘åœ£å® è¾¾æ ‡ï¼Œä½ å·²è¢«å†Œå°ä¸º${p.rank}ï¼</b>`;
                }

                if (!promotionMsg.includes("ã€æ™‹å‡ã€‘")) {
                    p.quarter++; 
                    if(p.quarter > 4){ p.quarter = 1; p.year++; emperor.currentYear++; }
                }

                updateStatPanel();
                document.getElementById('story-text').innerHTML = `<div class="message">${resultText}${promotionMsg}</div>`;
                area.innerHTML = `
<button class="choice-btn" onclick="
    if (pendingDeathReason) {
        const reason = pendingDeathReason;
        pendingDeathReason = null;
        gameOver(reason);
    } else {
        showPlot();
    }
">ç»§ç»­</button>
`;

            };
            area.appendChild(btn);
        });
    }
    // --- éŸ³é¢‘é…ç½® ---
const BGM_START = BASE_URL + 'bgm_start.mp3';
const BGM_GAME = [BASE_URL + 'bgm_game1.mp3', BASE_URL + 'bgm_game2.mp3'];
let currentGameBgmIdx = 0;

const bgmPlayer = document.getElementById('bgm-player');
const sePlayer = document.getElementById('se-player');

// æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ
function playClick() {
    sePlayer.src = BASE_URL + 'se_click.mp3';
    sePlayer.volume = document.getElementById('se-vol').value;
    sePlayer.play();
}

// åˆ‡æ¢èƒŒæ™¯éŸ³ä¹
function switchBGM(type) {
    if (type === 'start') {
        bgmPlayer.src = BGM_START;
    } else if (type === 'game') {
        // å®ç°ä¸¤é¦–éŸ³ä¹å¾ªç¯åˆ‡æ¢
        bgmPlayer.src = BGM_GAME[currentGameBgmIdx];
        bgmPlayer.onended = () => {
            currentGameBgmIdx = (currentGameBgmIdx + 1) % BGM_GAME.length;
            switchBGM('game');
        };
        // æ³¨æ„ï¼šæ¸¸æˆå†…éŸ³ä¹æˆ‘ä»¬å…³é—­æ ‡ç­¾è‡ªå¸¦çš„ loopï¼Œæ”¹ç”¨ä¸Šé¢çš„ onended æ‰‹åŠ¨åˆ‡æ¢
        bgmPlayer.loop = false;
    }
    
    bgmPlayer.volume = document.getElementById('bgm-vol').value;
    bgmPlayer.play().catch(e => console.log("ç­‰å¾…ç”¨æˆ·äº¤äº’åæ’­æ”¾éŸ³é¢‘"));
}

// å®æ—¶è°ƒèŠ‚éŸ³é‡
function adjustVolume() {
    bgmPlayer.volume = document.getElementById('bgm-vol').value;
    sePlayer.volume = document.getElementById('se-vol').value;
}

function showEnding(title, msg) {
        document.getElementById('page-game').innerHTML = `<div class="end-card"><h2 style="color:var(--palace-red);">${title}</h2><div style="line-height:1.8; margin:20px 0;">${msg}</div><button class="choice-btn" onclick="location.reload()">å†å…¥è½®å›</button></div>`;
    }

function gameOver(res) {
    switchBGM('start'); // åˆ‡æ¢å›æ‚²ä¼¤/è‚ƒç©†çš„åˆå§‹éŸ³ä¹
    if (typeof switchBGM === "function") switchBGM('start'); 
    
    // éšè—ç¯ç¬¼å’Œä¾§è¾¹æ é˜²æ­¢ç©¿å¸®
    const trigger = document.getElementById('menu-trigger');
    if(trigger) trigger.classList.add('hidden');
    document.getElementById('stat-panel').classList.remove('open');

    // å¼ºåˆ¶é»‘åº•çº¢å­—å…¨å±è¦†ç›–
    document.getElementById('page-game').innerHTML = `
        <div style="background:#000; color:#b00; height:100%; width:100%; position:absolute; top:0; left:0; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:30px; text-align:center; box-sizing:border-box; z-index:9999;">
            <h1 style="font-size:3rem; letter-spacing:15px; margin-bottom:10px; border-bottom:2px solid #b00; color:#b00;">é¦™æ¶ˆç‰æ®’</h1>
            <p style="color:#555; font-size:0.9rem; margin-bottom:30px;">â€”â€” æ­¤ç”Ÿç¼˜å°½ï¼Œæ¥ä¸–è«å…¥å¸ç‹å®¶ â€”â€”</p>
            <div style="font-size:1.2rem; line-height:1.8; color:#ccc; margin-bottom:40px; border:1px double #400; padding:20px;">
                ${res}
            </div>
            <button class="choice-btn" style="background:#300; color:#b00; border:1px solid #b00; width:200px;" onclick="location.reload()">å†å…¥è½®å›</button>
        </div>`;
}

    function resistDecree() { 
        document.getElementById('identity-content').innerHTML = `<div class="dead-card"><h2>é›·éœ†ä¹‹æ€’</h2><div style="margin:20px 0;">æŠ—æ—¨ä¸å°Šæ˜¯å¤§ç½ªï¼Œä½ è¢«èµä¸‹ä¸€å°ºç™½ç»«ï¼Œå®¶ä¸­æ»¡é—¨äº¦å—ç‰µè¿ã€‚</div><button class="choice-btn" onclick="location.reload()">é‡æ–°å¼€å§‹</button></div>`; 
    }
</script>
</body>
</html>












































