<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ·±å®«åç«  - å…¨å±æ€§å‘½è¿ç‰ˆ</title>
    <style>
        :root { --palace-red: #8b1b1b; --gold: #c5a059; --paper: #f4f1de; --ink: #2c2c2c; --success-bg: #fffafa; }
        body { margin: 0; padding: 0; background-color: #1a1a1a; font-family: "STKaiti", "KaiTi", serif; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #game-container { width: 95%; max-width: 450px; height: 90vh; background: var(--paper) url('https://www.transparenttextures.com/patterns/paper-fibers.png'); border: 8px solid var(--palace-red); outline: 2px solid var(--gold); outline-offset: -5px; position: relative; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.7); }
        header { background: var(--palace-red); color: var(--gold); padding: 15px 0; text-align: center; font-size: 1.6rem; letter-spacing: 6px; border-bottom: 4px double var(--gold); z-index: 5; }
        #scene { flex-grow: 1; padding: 25px; display: flex; flex-direction: column; z-index: 4; overflow-y: auto; }
        
        /* ä¾§è¾¹æ æ ·å¼ä¼˜åŒ– */
        #stat-panel { position: absolute; right: -100%; top: 0; width: 80%; height: 100%; background: rgba(44, 44, 44, 0.95); color: #eee; transition: right 0.4s ease; z-index: 100; padding: 40px 20px; box-sizing: border-box; border-left: 4px solid var(--gold); display: none; overflow-y: auto; }
        #stat-panel.active { display: block; }
        #stat-panel.open { right: 0; }
        .stat-group { margin-bottom: 20px; border: 1px solid var(--gold); padding: 10px; background: rgba(0,0,0,0.3); }
        .stat-group h4 { margin: 0 0 10px 0; color: var(--gold); border-bottom: 1px solid var(--gold); padding-bottom: 5px; font-size: 1rem; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; border-bottom: 1px dotted rgba(255,255,255,0.1); }
        .stat-val { color: var(--gold); font-weight: bold; }

        #menu-trigger { position: absolute; bottom: 20px; right: 20px; width: 55px; height: 55px; background: var(--gold); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 30px; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.4); z-index: 101; }
        .message { background: rgba(255,255,255,0.6); padding: 20px; border: 1px solid var(--gold); line-height: 1.8; color: var(--ink); font-size: 1.1rem; margin-bottom: 25px; }
        .choice-btn { background: white; color: var(--palace-red); border: 1px solid var(--palace-red); padding: 12px 15px; margin-bottom: 12px; cursor: pointer; font-family: "STKaiti", serif; font-size: 1rem; transition: 0.3s; box-shadow: 2px 2px 0 var(--gold); }
        .choice-btn:hover { background: var(--palace-red); color: var(--gold); transform: translateX(3px); }
        .btn-danger { color: #fff; background: #660000; border-color: #330000; }
        .hidden { display: none !important; }
        input[type="text"] { background: transparent; border: none; border-bottom: 2px solid var(--palace-red); width: 70%; padding: 10px; font-size: 1.2rem; text-align: center; margin: 30px 0; outline: none; font-family: "STKaiti", serif; }
        #loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:var(--paper); z-index:1000; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .end-card { border: 4px double var(--gold); background: var(--success-bg); padding: 30px; text-align: center; min-height: 70%; display: flex; flex-direction: column; justify-content: center; }
        .dead-card { border: 4px solid #600; background: #1a0000; color: #ff4d4d; padding: 30px; text-align: center; height: 100%; display: flex; flex-direction: column; justify-content: center; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="loading-overlay"><div id="load-status">æ­£åœ¨åŠ è½½å®«å»·å·å®—...</div></div>
    <header>æ·±å®«åç« </header>
    
    <div id="stat-panel">
        <h2 style="text-align:center; color:var(--gold); letter-spacing: 5px;">ä¸ªäººæ¡£ç±</h2>
        <div id="stat-content"></div>
        <button class="choice-btn" style="width:100%; margin-top:20px; background:transparent; color:var(--gold); border-color:var(--gold);" onclick="toggleStats()">åˆä¸Šå·è½´</button>
    </div>

    <div id="menu-trigger" class="hidden" onclick="toggleStats()">ğŸ®</div>
    
    <div id="scene">
        <div id="page-start" style="text-align: center; margin-top: 60px;">
            <h1 style="color: var(--palace-red); letter-spacing: 12px;">ç™¾èŠ±é½æ”¾</h1>
            <input type="text" id="p-name" placeholder="è¯·è¾“å…¥èŠ³å">
            <br>
            <button class="choice-btn" style="padding: 15px 50px; font-size: 1.2rem;" onclick="generateIdentity()">æ±‚å–ç­¾æ–‡</button>
        </div>

        <div id="page-identity" class="hidden">
            <div id="identity-content">
                <div class="message" style="text-align: center;" id="era-intro"></div>
                <div style="border: 2px solid var(--palace-red); padding: 20px; background: #fffafa; text-align: center; margin-bottom: 20px;">
                    <h2 id="display-rank" style="color: var(--palace-red); margin: 0;"></h2>
                    <div id="display-stats-preview" style="margin-top: 15px; text-align: left; display: inline-block; line-height: 2;"></div>
                </div>
                <button class="choice-btn" style="width: 100%;" onclick="enterPalace()">é¢†æ—¨å…¥å®«</button>
                <button class="choice-btn btn-danger" style="width: 100%; margin-top: 10px;" onclick="resistDecree()">æŠ—æ—¨ä¸å°Š</button>
            </div>
        </div>

        <div id="page-game" class="hidden">
            <div id="story-text" class="message"></div>
            <div id="choices-area"></div>
        </div>
    </div>
</div>

<script>
    const CSV_URL = 'https://raw.githubusercontent.com/brorobooo/palace-game/main/plot.csv';
    let eraNames = ["æ˜­æ™¯", "æ°¸å®", "ç››å¹³", "å…ƒç¦§", "å˜‰ä½‘", "é–å’Œ", "å¤©æˆ", "æ‰¿å¾·", "æ™¯æœ”", "ä¸‡å®"];
    let emperor = { eraName: "", currentYear: 0, deathYear: 0 };
    let p = { name: "", rank: "", year: 1, quarter: 1, stats: {}, children: { male: 0, female: 0 }, pregTimer: -1 };
    let plotLibrary = [];
    let usedPlotIds = new Set(); 

// --- ç»“å±€æ•°æ®åº“ï¼ˆæ–‡é›…ä¼˜åŒ–ç‰ˆ & å…¨ä½ä»½å…¬ä¸»è¡¥å®Œï¼‰ ---
    const ENDING_DB = {
        "ç­”åº”": { 
            son: [
                { title: "é•¿ä¿¡ç©ºç¯", text: "å…ˆå¸é©¾å´©ï¼Œæ–°å¸ç™»åŸºã€‚ä½ ä½ä»½ä½å¾®ï¼Œæ— ç¼˜å‰å¾€çš‡å­å°åœ°ã€‚æ–°å¸å¿µåŠå…„å¼Ÿæƒ…åˆ†ï¼Œå°†ä½ å®‰ç½®åœ¨çš‡å®¶åˆ«è‹‘ï¼Œè¡£é£Ÿæ— å¿§å´ç»ˆç”Ÿä¸å¾—è¸å‡ºè‹‘é—¨ã€‚ä½ å°†æ‰€æœ‰å¸Œæœ›å¯„æ‰˜åœ¨çš‡å­èº«ä¸Šï¼Œä½™ç”Ÿåœ¨æ€å¿µä¸æœŸç›¼ä¸­åº¦è¿‡ã€‚" },
                { title: "å°åœ°é¢å…»", text: "ä½ çš„çš‡å­å—å°éƒ¡ç‹ï¼Œå¾—ä»¥å‰å¾€å°åœ°å°±è—©ã€‚ä½ çªç ´ä½ä½å«”å¦ƒçš„å®¿å‘½ï¼Œéšå­å‰å¾€å°åœ°ï¼Œæˆä¸ºç‹åºœå¤ªå¦ƒã€‚è¿œç¦»å®«å»·çº·äº‰ï¼Œä¸å¿…å†çœ‹ä»–äººè„¸è‰²ï¼Œè™½æ— æ— ä¸ŠæƒåŠ¿ï¼Œå´æ‹¥æœ‰äº†å¯»å¸¸å¦‡äººçš„å®‰ç¨³ï¼Œå®‰äº«æ™šå¹´ã€‚" },
                { title: "å¤±æ€™ä¼¶ä»ƒ", text: "å…ˆå¸éª¤å´©ï¼Œä½ å¹´å¹¼çš„çš‡å­å—æƒŠæŸ“ç—…å¤­æŠ˜ã€‚å¤±å»å”¯ä¸€çš„ä¾é ï¼Œä½ è¢«é—å¿˜åœ¨å†·å®«åæ®¿ã€‚æ— äººé—®æ´¥ï¼Œç²—èŒ¶æ·¡é¥­ï¼Œåœ¨æ— å°½çš„å­¤å¯‚ä¸æ‚²ç—›ä¸­ï¼Œæ½¦è‰èµ°å®Œä¸€ç”Ÿã€‚" }
            ],
            daughter: [
                { title: "åˆ«è‹‘æ™šé¦™", text: "è™½æ— çš‡å­åŠ å°ï¼Œä½†æ–°å¸å¿µä½ è‚²æœ‰å…¬ä¸»ï¼Œå…ä½ å®ˆé™µä¹‹è‹¦ï¼Œå°†ä½ å®‰ç½®åœ¨è¡Œå®«å…»è€ã€‚å…¬ä¸»æ—¶å¸¸å¥‰æ—¨æ¢æœ›ï¼Œè™½æ— å¤§å¯Œå¤§è´µï¼Œå€’ä¹Ÿåœ¨æ¯å¥³æ¸©æƒ…ä¸­å¾—äº†ä¸€ä»½å®‰å®ã€‚" }
            ],
            none: [
                { title: "é’ç¯ä¼´å†¢", text: "ä½œä¸ºæ— å® æ— å—£çš„ä½ä½å«”å¦ƒï¼Œä½ è¢«å®‰æ’å‰å¾€çš‡å®¶é™µå¯ï¼Œä¸ºå…ˆå¸å®ˆé™µã€‚é’ç¯å¤ä½›ï¼Œé»„åœŸå­¤å†¢ï¼Œæ­¤ç”Ÿä¸ç¹åå®«å»·å½»åº•éš”ç»ï¼Œåœ¨æ¸…å†·ä¸å­¤å¯‚ä¸­è€—å°½ä½™ç”Ÿã€‚" },
                { title: "å½’éšå‡¡å°˜", text: "æ–°å¸æ¨è¡Œä»æ”¿ï¼Œå¤§èµ¦åå®«ã€‚ä½ å®¶æ—å°šæœ‰äº²äººåœ¨ä¸–ï¼Œå¾—ä»¥ç‰¹è®¸å‡ºå®«ï¼Œå›å½’æ°‘é—´ã€‚è¤ªå»å®«è£…ï¼Œå¸ä¸‹é’—ç¯ï¼Œä½ éšäºå¸‚äº•ï¼Œå«ä½œå‡¡äººå¦‡ï¼Œè¿‡ä¸Šäº†å¹³æ·¡çš„ç”Ÿæ´»ã€‚" },
                { title: "æ¯éª¨æ— äºº", text: "ä½ æ— å® æ— åŠ¿ä¸”æ— å­å—£ï¼Œè¢«éšæ„å®‰ç½®åœ¨å†·å®«åæ®¿ã€‚å®«ä¸­æ–°äººæ¢æ—§äººï¼Œå†ä¹Ÿæ— äººè®°å¾—ä½ çš„å­˜åœ¨ã€‚æœ€ç»ˆåœ¨æ— äººçŸ¥æ™“çš„æ—¥å­é‡Œï¼Œæ‚„ç„¶ç¦»ä¸–ã€‚" }
            ] 
        },
        "è´µäºº": { 
            son: [
                { title: "é‡‘å°è£å½’", text: "ä½ çš„çš‡å­å¤©èµ„èªé¢–ï¼Œè·å°äº²ç‹ã€‚ä½ è¢«å°Šä¸ºçš‡å¤ªå¦ƒï¼Œè¿å±…å¤ªå¦ƒåºœï¼Œäº«æœ‰ä¸°åšä¿¸ç¦„ã€‚çš‡å­æ—¶å¸¸å‰æ¥è¯·å®‰ï¼Œä½ åœ¨å°Šå´‡ä¸äº²æƒ…ä¸­ï¼Œå®‰åº¦å¯Œè´µæ™šå¹´ã€‚" },
                { title: "ç¦å®«ä½™æ¨", text: "ä½ çš„çš‡å­æ›¾å‚ä¸å¤ºå«¡æœ€ç»ˆè½è´¥ã€‚æ–°å¸å¿µåŠæ‰‹è¶³ä»…å°†å…¶è´¬ä¸ºåº¶äººï¼Œä½ å´è¢«å‰¥å¤ºå°å·ï¼Œç¦è¶³åœ¨ååƒ»å®«æ®¿ï¼Œç»ˆç”Ÿä¸å¾—ä¸å­ç›¸è§ï¼Œåœ¨æ‚”æ¨ä¸­è‹Ÿæ´»ã€‚" }
            ], 
            daughter: [
                { title: "å’Œäº²ç¦»æ€¨", text: "ä½ è‚²æœ‰å…¬ä¸»ï¼Œæ–°å¸ä¸ºç¨³å›ºé‚¦äº¤å°†å…¶é€å¾€è¿œå«å’Œäº²ã€‚æ–°å¸æ„Ÿå¿µä½ çš„éšå¿ï¼ŒåŠ å°ä½ ä¸ºå«”ã€‚ä½ æ—¶å¸¸æœ›ç€å’Œäº²çš„æ–¹å‘ï¼Œä½™ç”Ÿåœ¨æ€å¿µä¸è™šè£çš„ä½åˆ†ä¸­äº¤ç»‡ã€‚" }
            ], 
            none: [
                { title: "æ¢µéŸ³æ´—å°˜", text: "ä½ ä¸»åŠ¨è¯·æ—¨å‰å¾€çš‡å®¶å¯ºé™¢ä¿®è¡Œã€‚æ¯æ—¥è¯µç»ç¤¼ä½›ï¼Œæ¸…å¿ƒå¯¡æ¬²ã€‚å®«ä¸­ä¼šæŒ‰æ—¶é€æ¥ä»½ä¾‹ï¼Œä½ å®‰ç„¶åº¦è¿‡ä½™ç”Ÿï¼Œæ­»åä»¥å¤ªå¦ƒä¹‹ç¤¼å®‰è‘¬ã€‚" },
                { title: "ä¾é™„æƒåŠ¿", text: "ä½ æ—©å¹´ä¸æŸä½è´µå¦ƒäº¤å¥½ï¼Œå¯¹æ–¹å­å—£ç™»åŸºã€‚ä½ å‡­å€Ÿæ—§æƒ…å¾—åˆ°ç”Ÿæ¯ç…§æ‹‚ï¼Œå®‰ç½®åœ¨ä¼˜æ¸¥å®«æ®¿ã€‚è™½æ— éª¨è‚‰ï¼Œå´èƒ½å®‰ç¨³åº¦æ—¥ï¼Œå¾—ä»¥å–„ç»ˆã€‚" },
                { title: "æ™šæ™¯è½ç´¢", text: "ä½ æ›¾å‚ä¸å®«æ–—å¾—ç½ªæ–°å¸ç”Ÿæ¯ã€‚å…ˆå¸é©¾å´©åè¢«æ¸…ç®—ï¼Œè´¬ä¸ºåº¶äººé€å‡ºçš‡å®«ã€‚ä½ å¤±å»æ‰€æœ‰è£åï¼Œæµè½æ°‘é—´ï¼Œæ™šæ™¯å‡„å‡‰ã€‚" }
            ] 
        },
        "å¦ƒ": { 
            son: [
                { title: "ç å¸˜å‚æ”¿", text: "ä½ çš„çš‡å­æ˜¯æ–°å¸çš„å¾—åŠ›è‡‚è†€ã€‚ä½ è¢«å†Œå°ä¸ºçš‡è€ƒè´µå¦ƒï¼Œåœ°ä½ä»…æ¬¡äºå¤ªåã€‚åå®«ä¹‹ä¸­æ— äººæ•¢ä¸ä½ æŠ—è¡¡ï¼Œä½ ååŠ©å¤ªåç®¡ç†åå®«ï¼Œæƒå€¾ä¸€æ—¶ã€‚" },
                { title: "è—©ç‹è‡³å°Š", text: "ä½ çš„çš‡å­å—å°å¯Œåº¶äº²ç‹ã€‚ä½ å‰å¾€å°åœ°æˆä¸ºæœ€å°Šè´µçš„å¤ªå¦ƒã€‚çš‡å­å­é¡ºï¼Œä½ æ— éœ€ç†ä¼šæœå ‚çº·äº‰ï¼Œå°½äº«è£åå¯Œè´µï¼Œå¯¿ç»ˆæ­£å¯ã€‚" },
                { title: "æ³£è¡€æ…ˆæ¯", text: "çš‡å­é­å¥¸äººé™·å®³è¢«èµæ­»ã€‚ä½ è¢«åºŸé»œå°å·ï¼Œç¦è¶³åœ¨çš‡é™µå®«æ®¿ã€‚ä½™ç”Ÿéƒ½åœ¨ä¸ºå„¿å­ç¥ˆç¦ï¼Œåœ¨æ— å°½çš„ç—›è‹¦ä¸­ç¦»ä¸–ã€‚" }
            ], 
            daughter: [
                { title: "åé˜³æ™šç¦", text: "è™½æ— çš‡å­ï¼Œä½†ä½ çš„å¤šä½å…¬ä¸»çš†å«å…¥åé—¨ã€‚æ–°å¸ç¤¼é‡åŠŸè‡£ï¼Œå°Šä½ ä¸ºå¤ªå¦ƒï¼Œè®©ä½ åœ¨å®«ä¸­é¢å…»å¤©å¹´ã€‚æ¯é€¢ä½³èŠ‚ï¼Œå¥³å„¿å¥³å©¿å…¥å®«è§è§ï¼Œä¹Ÿç®—äº«å°½å¤©ä¼¦ä¹‹ä¹ã€‚" }
            ],
            none: [
                { title: "å¾·æœ›é•¿è€…", text: "ä½ ä¸€ç”Ÿè´¤è‰¯æ·‘å¾·ã€‚è™½æ— å­å—£ï¼Œæ–°å¸ä¾æ—§å°Šä½ ä¸ºçš‡å¤ªå¦ƒã€‚ä½ ä¸å‚ä¸çº·äº‰ï¼Œå®‰äº«æ¸…ç¦ï¼Œæˆä¸ºåå®«ä¸­å—äººæ•¬é‡çš„é•¿è€…ã€‚" },
                { title: "æ¯å®¶æ©è«", text: "ä½ çš„å®¶æ—åœ¨æœå ‚ä¸ŠæƒåŠ¿ç¨³å›ºã€‚æ–°å¸ä¸ºæ‹‰æ‹¢å®¶æ—å¯¹ä½ ç¤¼é‡æœ‰åŠ ã€‚ä½ å‡­å€Ÿå®¶æ—åŠ¿åŠ›åœ¨åå®«æ‹¥æœ‰ä¸€å¸­ä¹‹åœ°ï¼Œå®‰ç¨³åº¦è¿‡ä½™ç”Ÿã€‚" },
                { title: "ä»™è‹‘é—²äº‘", text: "ä½ çœ‹é€æ²‰æµ®ï¼Œä¸»åŠ¨è¯·æ—¨å‰å¾€åˆ«é™¢ã€‚ä½ åœ¨åˆ«é™¢ç§èŠ±ç§è‰ï¼Œé—²äº‘é‡é¹¤ï¼Œè¿œç¦»çº·äº‰ï¼Œåº¦è¿‡æƒ¬æ„çš„æ™šå¹´ã€‚" }
            ] 
        },
        "è´µå¦ƒ": { 
            son: [
                { title: "æ…ˆå®å¤•ç…§", text: "ä½ çš„å„¿å­ç™»åŸºä¸ºå¸ã€‚ä½ æ¯å‡­å­è´µè¢«å°Šä¸ºçš‡å¤ªåï¼Œå…¥ä½æ…ˆå®å®«ã€‚æ‰‹æ¡åå®«å¤§æƒï¼Œå‚å¸˜å¬æ”¿ã€‚ä½ æˆä¸ºäº†å¤©ä¸‹æœ€å°Šè´µçš„å¥³äººã€‚" },
                { title: "å°ç–†å¤ªå¦ƒ", text: "ä½ çš„çš‡å­æœªèƒ½ç»§æ‰¿å¤§ç»Ÿã€‚æ–°å¸æ„Ÿå¿µä½ çš„åŠ¿åŠ›å°Šä½ ä¸ºçš‡å¤ªå¦ƒã€‚ä½ æºçš‡å­å‰å¾€å°åœ°ï¼Œä¸æ–°å¸äº’ä¸å¹²æ¶‰ï¼Œå®‰ç¨³ä¿å…¨å®¶æ—ã€‚" },
                { title: "æƒç•¥æ˜¥ç§‹", text: "æ–°å¸å¹´å¹¼ï¼Œä½ ä½œä¸ºçš‡å­ç”Ÿæ¯è”åˆæœè‡£è¾…æ”¿ã€‚è™½æ— å¤ªåä¹‹åï¼Œå´æœ‰å¤ªåä¹‹å®ï¼Œä¸€ç”Ÿåœ¨ç‹æœæƒåŠ›ä¸­å¿ƒå‘¨æ—‹ã€‚" }
            ], 
            daughter: [
                { title: "é•¿å®å°Šå…»", text: "ä½œä¸ºå…ˆå¸è´µå¦ƒï¼Œä½ è™½åªæœ‰å…¬ä¸»ï¼Œä½†æ–°å¸ä»å°Šä½ ä¸ºçš‡è€ƒè´µå¦ƒã€‚ä½ åœ¨å®«ä¸­äº«æœ‰æé«˜çš„è§„æ ¼å¾…é‡ï¼Œè¿æ–°ä»»çš‡åä¹Ÿè¦å¯¹ä½ ç¤¼è®©ä¸‰åˆ†ï¼Œå¯Œè´µä¸€ç”Ÿã€‚" }
            ],
            none: [
                { title: "åç•™å²ä¼ ", text: "ä½ èƒ½åŠ›å‡ºä¼—è¢«æ‰˜ä»˜è¾…ä½æ–°å¸ã€‚è™½æ— å­å—£å´æ·±å¾—ä¿¡ä»»ã€‚ä½ ååŠ©å¤ªåç¨³å®šå±€åŠ¿ï¼Œæˆä¸ºä¸€ä»£è´¤å¦ƒï¼Œåç•™é’å²ã€‚" },
                { title: "æŠšè‚²æ©é‡", text: "ä½ æ›¾æŠšè‚²æ–°å¸ã€‚æ–°å¸ç™»åŸºåå°Šä½ ä¸ºçš‡å¤ªå¦ƒï¼Œç»™äºˆæ— ä¸Šç¤¼é‡ã€‚ä½ åœ¨å®«ä¸­å®‰äº«è£åï¼Œåœ°ä½è¶…ç„¶ã€‚" },
                { title: "å­¤ç¯å‡„å½±", text: "ä½ æ›¾ä¸æ–°å¸ç”Ÿæ¯åŠ¿åŒæ°´ç«ã€‚å…ˆå¸é©¾å´©åè£åå°½å¤±ï¼Œè¢«è¿å±…ååƒ»å®«æ®¿ï¼Œåœ¨å¯‚å¯ä¸­åº¦è¿‡ä½™ç”Ÿã€‚" }
            ] 
        },
        "çš‡å": { 
            son: [
                { title: "æ¯ä»ªå¤©ä¸‹", text: "ä½ çš„å«¡å­ç»§ä½ã€‚ä½ åæ­£è¨€é¡ºå°Šä¸ºåœ£æ¯çš‡å¤ªåï¼Œæ‰§æŒåå®«ã€‚è¾…ä½æ–°å¸å¼€åˆ›ç››ä¸–ï¼Œæ­»åä¸å…ˆå¸åˆè‘¬ï¼Œäº«å°½å“€è£ã€‚" },
                { title: "å«¡æ¯å°Šä½", text: "æ–°å¸ä¸ºåº¶å­ï¼Œä½ ä¾æ—§ä»¥å«¡æ¯èº«ä»½å°Šä¸ºçš‡å¤ªåã€‚å‡­å€Ÿåœ°ä½ç¨³ååå®«å¤´æŠŠäº¤æ¤…ï¼ŒæŒæ§åå®«æ ¼å±€ã€‚" },
                { title: "å®šé¼è¾…å›½", text: "çš‡å­å¹´å¹¼ç™»åŸºï¼Œä½ ä½œä¸ºæ‰˜å­¤ä¹‹äººç¨³å®šæœå±€ã€‚ä½ ä¸€ç”Ÿä¸ºçš‡å®¤åŸºä¸šæ“åŠ³ï¼Œæˆä¸ºåŠ›æŒ½ç‹‚æ¾œçš„ä¸€ä»£è´¤åã€‚" }
            ], 
            daughter: [
                { title: "é•¿ä¹å¤ªå", text: "å…ˆå¸é©¾å´©æ—¶ä½ ä»…è‚²æœ‰å…¬ä¸»ï¼Œä½†ä½œä¸ºæ­£å®«çš‡åï¼Œä½ è¢«å°Šä¸ºæ¯åçš‡å¤ªåã€‚å³ä¾¿æ–°å¸ç”Ÿæ¯åœ¨ä¸–ï¼Œä¹Ÿéœ€å‘ä½ è¡Œç¤¼ã€‚ä½ ä¸€ç”Ÿè´µä¸å¯è¨€ã€‚" }
            ],
            none: [
                { title: "ç»§åé•¿å°Š", text: "è™½æ— å­å—£ï¼Œä½†ä½ è´¤è‰¯æ·‘å¾·ã€‚æ–°å¸ä¾æ—§å°Šä½ ä¸ºæ¯åçš‡å¤ªåã€‚ä½ ç¨³å±…åå®«ä¸»æŒå¤§å±€ï¼Œå®‰äº«æ— ä¸Šå°Šè£ã€‚" },
                { title: "å½’é¹¤ç„é—¨", text: "ä½ çœ‹é€æœå ‚ä¸»åŠ¨æ”¾å¼ƒæƒåŠ›ï¼Œå‰å¾€çš‡é™µå®ˆé™µã€‚é’ç¯å¤ä½›ç›¸ä¼´ï¼Œä¸ºå…ˆå¸ä¸è‹ç”Ÿç¥ˆç¦ï¼Œå®‰ç„¶ç¦»ä¸–ã€‚" },
                { title: "å‡¤å°é—æ¨", text: "ä½ æ— å­ä¸”åœ¨å¤ºå«¡ä¸­ç«™é”™é˜Ÿã€‚æ–°å¸ç™»åŸºååºŸé»œä½ ä¸ºåº¶äººï¼Œå›šç¦åœ¨å†·å®«ã€‚æ›¾ç»çš„åå®«ä¹‹ä¸»ï¼Œæ™šæ™¯å‡„å‡‰ã€‚" }
            ] 
        }
    };

    window.onload = async function() {
        try {
            const response = await fetch(CSV_URL);
            const buffer = await response.arrayBuffer();
            const text = new TextDecoder('utf-8').decode(buffer);
            parseCSV(text);
            document.getElementById('loading-overlay').classList.add('hidden');
        } catch (err) { document.getElementById('load-status').innerText = "åŠ è½½å¤±è´¥"; }
    };

    function parseCSV(text) {
        const rows = text.split(/\r?\n/).filter(line => line.trim() !== "");
        const dataRows = rows.slice(1); 
        plotLibrary = dataRows.map(row => {
            const cols = row.split(',');
            if (cols.length < 28) return null; 
            return {
                id: cols[0].trim(), rank: cols[1].trim(), year: parseInt(cols[2]),
                title: cols[4], text: cols[5],
                choices: [
                    { text: cols[6], checkAttr: cols[7].trim(), checkVal: parseInt(cols[8]), resOk: cols[9], resFail: cols[10], stats: { beauty: +cols[11], talent: +cols[12], wit: +cols[13], body: +cols[14], prestige: +cols[15], favor: +cols[16] }, newRank: cols[17].trim() },
                    { text: cols[18], checkAttr: cols[19].trim(), checkVal: parseInt(cols[20]), resOk: cols[21], resFail: cols[22], stats: { beauty: +cols[23], talent: +cols[24], wit: +cols[25], body: +cols[26], prestige: +cols[27], favor: +cols[28] || 0 }, newRank: cols[29] ? cols[29].trim() : "" }
                ],
                isBed: cols[30] ? cols[30].trim() : "0" 
            };
        }).filter(i => i);
    }

    function rnd(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    function generateIdentity() {
        const nameInput = document.getElementById('p-name').value;
        if (!nameInput) return alert("è¯·èµå");
        p.name = nameInput;
        emperor.eraName = eraNames[Math.floor(Math.random() * eraNames.length)];
        emperor.currentYear = rnd(1, 20); 
        emperor.deathYear = rnd(30, 35); 
        const ranks = ["å®«å¥³", "ç­”åº”", "è´µäºº"];
        p.rank = ranks[Math.floor(Math.random() * 3)]; 
        const base = { "å®«å¥³":[20,40], "ç­”åº”":[35,55], "è´µäºº":[50,70] }[p.rank];
        p.stats = { beauty: rnd(base[0],base[1]), talent: rnd(base[0],base[1]), wit: rnd(base[0],base[1]), body: rnd(40,60), prestige: rnd(5,15), favor: p.rank === "å®«å¥³" ? 0 : rnd(1, 10) };
        
        document.getElementById('page-start').classList.add('hidden');
        document.getElementById('page-identity').classList.remove('hidden');
        document.getElementById('era-intro').innerHTML = `å½“ä»Šåœ£ä¸Šå¹´å·<b>ã€${emperor.eraName}ã€‘</b>ï¼Œå·²åœ¨ä½<b>${emperor.currentYear}</b>è½½ã€‚`;
        document.getElementById('display-rank').innerText = `${p.name} Â· ${p.rank}`;
        document.getElementById('display-stats-preview').innerHTML = `å®¹è²Œï¼š${p.stats.beauty} &nbsp; æ‰æƒ…ï¼š${p.stats.talent}<br>å¿ƒæœºï¼š${p.stats.wit} &nbsp; ä½“è´¨ï¼š${p.stats.body}<br>å£°æœ›ï¼š${p.stats.prestige} &nbsp; åœ£å® ï¼š${p.stats.favor}`;
    }

    function enterPalace() {
        document.getElementById('page-identity').classList.add('hidden');
        document.getElementById('page-game').classList.remove('hidden');
        document.getElementById('menu-trigger').classList.remove('hidden');
        document.getElementById('stat-panel').classList.add('active');
        updateStatPanel();
        showPlot();
    }

    function toggleStats() { document.getElementById('stat-panel').classList.toggle('open'); }

    // --- æ ¸å¿ƒä¿®å¤ï¼šè¡¥å…¨æ¡£ç±ä¿¡æ¯ ---
    function updateStatPanel() {
        let status = p.pregTimer >= 0 ? "æ€€æœ‰èº«å­•" : "å¸¸æ€";
        document.getElementById('stat-content').innerHTML = `
            <div class="stat-group">
                <h4>å®«å»·èƒŒæ™¯</h4>
                <div class="stat-row"><span>å½“å‰å¹´å·</span><span class="stat-val">${emperor.eraName} ${emperor.currentYear}å¹´</span></div>
                <div class="stat-row"><span>å…¥å®«æ—¶é•¿</span><span class="stat-val">ç¬¬${p.year}å¹´ ç¬¬${p.quarter}å­£</span></div>
            </div>
            <div class="stat-group">
                <h4>ä¸ªäººçŠ¶æ€</h4>
                <div class="stat-row"><span>å§“åä½ä»½</span><span class="stat-val">${p.name} Â· ${p.rank}</span></div>
                <div class="stat-row"><span>èº«ä½“çŠ¶å†µ</span><span class="stat-val">${status}</span></div>
                <div class="stat-row"><span>çš‡å­/å…¬ä¸»</span><span class="stat-val">${p.children.male}ç”· / ${p.children.female}å¥³</span></div>
            </div>
            <div class="stat-group">
                <h4>å„é¡¹æ•°å€¼</h4>
                <div class="stat-row"><span>å®¹è²Œ</span><span class="stat-val">${p.stats.beauty}</span></div>
                <div class="stat-row"><span>æ‰æƒ…</span><span class="stat-val">${p.stats.talent}</span></div>
                <div class="stat-row"><span>ä½“è´¨</span><span class="stat-val">${p.stats.body}</span></div>
                <div class="stat-row"><span>å¿ƒæœº</span><span class="stat-val">${p.stats.wit}</span></div>
                <div class="stat-row"><span>å£°æœ›</span><span class="stat-val">${p.stats.prestige}</span></div>
                <div class="stat-row"><span>åœ£å® </span><span class="stat-val" style="color:#ff4d4d">${p.stats.favor}</span></div>
            </div>
        `;
    }

    function handlePregnancy() {
        if (p.pregTimer >= 0) return;
        let chance = p.stats.body > 70 ? 0.5 : 0.2;
        if (Math.random() < chance) { p.pregTimer = 0; alert("ã€å–œè®¯ã€‘ä½ æ€€æœ‰é¾™è£”äº†ï¼"); }
        else { alert("ã€æ¶ˆæ¯ã€‘é¾™é¢œå¤§æ‚¦ã€‚"); }
        updateStatPanel();
    }

    function giveBirth() {
        let roll = Math.random();
        if (roll < 0.05) { p.children.male++; p.children.female++; alert("è¯ä¸‹é¾™å‡¤èƒï¼"); }
        else if (roll < 0.5) { p.children.male++; alert("è¯ä¸‹çš‡å­ï¼"); }
        else { p.children.female++; alert("è¯ä¸‹å…¬ä¸»ï¼"); }
        p.pregTimer = -1;
        updateStatPanel();
    }

    function showPlot() {
        if (p.pregTimer >= 0) { p.pregTimer++; if (p.pregTimer >= 3) giveBirth(); }
        if (emperor.currentYear >= emperor.deathYear) { /* é©¾å´©åˆ¤å®šé€»è¾‘... */ showEnding("å¤§é™å·²è‡³", "çš‡å¸é©¾å´©äº†ã€‚"); return; }

        let candidates = plotLibrary.filter(item => item.rank === p.rank && item.year === p.year && !usedPlotIds.has(item.id));
        if (candidates.length === 0) { usedPlotIds.clear(); candidates = plotLibrary.filter(item => item.rank === p.rank && item.year === p.year); }
        let s = candidates[Math.floor(Math.random() * candidates.length)] || { title: "æ·±å®«ç‹¬å¤„", text: "è¿™ä¸€å­£å®«ä¸­æ— äº‹ã€‚", choices: [{ text: "ç»§ç»­", resOk: "å²æœˆé™å¥½ã€‚", stats: {} }] };
        usedPlotIds.add(s.id);

        document.getElementById('story-text').innerHTML = `<strong>ã€${s.title}ã€‘</strong><br>${s.text}`;
        const area = document.getElementById('choices-area'); area.innerHTML = "";
        
        s.choices.forEach(c => {
            if(!c.text) return;
            let btn = document.createElement('button'); btn.className = "choice-btn"; btn.style.width = "100%"; btn.innerText = c.text;
            btn.onclick = () => {
                let pass = true;
                const attrKeyMap = {"å®¹è²Œ":"beauty","æ‰æƒ…":"talent","å¿ƒæœº":"wit","ä½“è´¨":"body","å£°æœ›":"prestige","åœ£å® ":"favor"};
                if(c.checkAttr && c.checkAttr !== "æ— " && p.stats[attrKeyMap[c.checkAttr] || c.checkAttr] < c.checkVal) pass = false;
                if(pass) {
                    for(let k in c.stats) if(p.stats[k] !== undefined) p.stats[k] += (c.stats[k] || 0);
                    if (s.isBed === "1") handlePregnancy();
                    if(c.newRank && c.newRank !== "" && c.newRank !== "ç»“å±€") p.rank = c.newRank;
                    p.quarter++; if(p.quarter > 4){ p.quarter = 1; p.year++; emperor.currentYear++; }
                    updateStatPanel();
                    document.getElementById('story-text').innerHTML = `<div class="message">${c.resOk}</div>`;
                    area.innerHTML = `<button class="choice-btn" style="width:100%" onclick="showPlot()">ç»§ç»­</button>`;
                } else {
                    gameOver(c.resFail || "ä½ æœªèƒ½é€šè¿‡è€ƒéªŒï¼Œæƒ¨æ­»å®«ä¸­ã€‚");
                }
            };
            area.appendChild(btn);
        });
    }

    function showEnding(title, msg) {
        document.getElementById('page-game').innerHTML = `
            <div class="end-card">
                <h2 style="color:var(--palace-red); letter-spacing: 5px;">${title}</h2>
                <div style="line-height:1.8; margin:20px 0; color:var(--ink);">${msg}</div>
                <button class="choice-btn" style="width:100%; margin-top:20px;" onclick="location.reload()">å†å…¥è½®å›</button>
            </div>`;
    }

    function gameOver(res) {
        document.getElementById('page-game').innerHTML = `
            <div class="dead-card"><h2>é­‚æ–­æ·±å®«</h2><div style="margin:20px 0;">${res}</div><button class="choice-btn" style="width:100%; background:#400; color:#fff;" onclick="location.reload()">é‡æ–°å¼€å§‹</button></div>`;
    }
    function resistDecree() { document.getElementById('identity-content').innerHTML = `<div class="dead-card"><h2>é›·éœ†ä¹‹æ€’</h2><div style="margin:20px 0;">æŠ—æ—¨ä¸å°Šï¼Œæ»¡é—¨æŠ„æ–©ï¼</div><button class="choice-btn" onclick="location.reload()">é‡æ–°å¼€å§‹</button></div>`; }
</script>
</body>
</html>

