<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ·±å®«åç«  - ç»ˆæé€‚é…ç‰ˆ</title>
    <style>
        :root { 
            --palace-red: #8b1b1b; 
            --gold: #c5a059; 
            --paper: #f4f1de; 
            --ink: #2c2c2c; 
            --success-bg: #fffafa; 
        }
        
        /* 1. åŸºç¡€å¸ƒå±€ä¿®å¤ï¼šå…è®¸å¤–å±‚æ»šåŠ¨é˜²æ­¢æˆªæ–­ */
        body { 
            margin: 0; padding: 0; background-color: #1a1a1a; 
            font-family: "STKaiti", "KaiTi", serif; 
            display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; overflow-y: auto; 
        }

        /* 2. æ ¸å¿ƒå®¹å™¨ï¼šè‡ªé€‚åº”é«˜åº¦ï¼Œæœ€å¤§ä¸è¶…å‡ºè§†å£ */
        #game-container { 
            width: 95%; 
            max-width: 500px; 
            height: auto;
            min-height: 80vh;
            max-height: 95vh; 
            background: var(--paper) url('https://www.transparenttextures.com/patterns/paper-fibers.png'); 
            border: 6px solid var(--palace-red); 
            outline: 2px solid var(--gold); 
            outline-offset: -4px; 
            position: relative; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
            margin: 20px 0; 
        }

        header { 
            background: var(--palace-red); color: var(--gold); 
            padding: 12px 0; text-align: center; 
            font-size: 1.4rem; letter-spacing: 5px; 
            border-bottom: 4px double var(--gold); 
            z-index: 5; flex-shrink: 0;
        }

        #scene { 
            flex-grow: 1; padding: 20px 20px 40px 20px; 
            display: flex; flex-direction: column; 
            z-index: 4; overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
        }

        /* 3. æ¡£ç±é¢æ¿æ ·å¼ */
        #stat-panel { 
            position: absolute; right: -100%; top: 0; 
            width: 85%; height: 100%; 
            background: rgba(139, 27, 27, 0.98); color: var(--gold); 
            transition: right 0.4s ease; z-index: 100; 
            padding: 40px 20px; box-sizing: border-box; 
            border-left: 3px solid var(--gold); 
        }
        #stat-panel.open { right: 0; }
        .stat-row { margin-bottom: 10px; border-bottom: 1px solid rgba(197, 160, 89, 0.3); padding: 5px 0; font-size: 1rem; }

        #menu-trigger { 
            position: absolute; bottom: 15px; right: 15px; 
            width: 50px; height: 50px; 
            background: var(--gold); border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            cursor: pointer; font-size: 24px; 
            border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.4); 
            z-index: 101; 
        }

        /* 4. æ–‡æœ¬ä¸æŒ‰é’® */
        .message { background: rgba(255,255,255,0.6); padding: 20px; border: 1px solid var(--gold); line-height: 1.7; color: var(--ink); font-size: 1.1rem; margin-bottom: 20px; }
        .choice-btn { 
            background: white; color: var(--palace-red); 
            border: 1px solid var(--palace-red); padding: 12px; 
            margin-bottom: 10px; cursor: pointer; 
            font-family: "STKaiti", serif; font-size: 1rem; 
            transition: 0.2s; box-shadow: 2px 2px 0 var(--gold);
            width: 100%; box-sizing: border-box;
        }
        .choice-btn:active { transform: scale(0.98); background: #eee; }
        .btn-danger { color: #fff; background: #660000; border-color: #330000; }
        .hidden { display: none !important; }
        
        input[type="text"] { 
            background: transparent; border: none; 
            border-bottom: 2px solid var(--palace-red); 
            width: 70%; padding: 10px; font-size: 1.2rem; 
            text-align: center; margin: 20px 0; outline: none; 
            font-family: "STKaiti", serif; 
        }

        /* 5. ç»“å±€å¡ç‰‡åŒºåˆ† */
        .end-card { border: 4px double var(--gold); background: var(--success-bg); padding: 25px; text-align: center; }
        .dead-card { 
            border: 4px solid #600; background: #1a0000; color: #ff4d4d; 
            padding: 25px; text-align: center; 
            min-height: 50%; display: flex; flex-direction: column; justify-content: center; 
        }

        /* æ‰‹æœºç«¯ç»†èŠ‚å¾®è°ƒ */
        @media (max-width: 600px) {
            #game-container { width: 92%; margin: 10px 0; border-width: 4px; }
            header { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="loading-overlay" style="position: absolute; top:0; left:0; width:100%; height:100%; background:var(--paper); z-index:1000; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div id="load-status" style="font-size: 1.2rem; color: var(--palace-red);">æ­£åœ¨æ•´ç†å·å®—...</div>
    </div>
    
    <header>æ·±å®«åç« </header>

    <div id="stat-panel">
        <h2 style="text-align:center; letter-spacing: 5px; border-bottom: 2px solid var(--gold); padding-bottom: 10px;">ä¸ªäººæ¡£ç±</h2>
        <div id="stat-content"></div>
        <button class="choice-btn" style="margin-top:30px;" onclick="toggleStats()">æ”¶å›æ¡£ç±</button>
    </div>

    <div id="menu-trigger" class="hidden" onclick="toggleStats()">ğŸ®</div>

    <div id="scene">
        <div id="page-start" style="text-align: center; margin-top: 40px;">
            <h1 style="color: var(--palace-red); letter-spacing: 10px;">ç™¾èŠ±é½æ”¾</h1>
            <input type="text" id="p-name" placeholder="è¯·è¾“å…¥èŠ³å">
            <br>
            <button class="choice-btn" style="width: 200px; font-size: 1.2rem;" onclick="generateIdentity()">æ±‚å–ç­¾æ–‡</button>
        </div>

        <div id="page-identity" class="hidden">
            <div id="identity-content">
                <div class="message" style="text-align: center;">é€‰ç§€å‘ˆæŠ¥ï¼Œèµ„æ–™å¦‚ä¸‹ï¼š</div>
                <div style="border: 2px solid var(--palace-red); padding: 15px; background: #fffafa; text-align: center; margin-bottom: 15px;">
                    <h2 id="display-rank" style="color: var(--palace-red); margin: 0; font-size: 1.4rem;"></h2>
                    <div id="display-stats" style="margin-top: 10px; text-align: left; display: inline-block; line-height: 1.8; font-size: 0.95rem;"></div>
                </div>
                <button class="choice-btn" onclick="enterPalace()">é¢†æ—¨å…¥å®«</button>
                <button class="choice-btn btn-danger" onclick="resistDecree()">æŠ—æ—¨ä¸å°Š</button>
            </div>
        </div>

        <div id="page-game" class="hidden">
            <div id="story-text" class="message"></div>
            <div id="choices-area"></div>
        </div>
    </div>
</div>

<script>
    const CSV_URL = 'https://raw.githubusercontent.com/brorobooo/palace-game/main/plot.csv';
    let p = { name: "", rank: "", year: 1, quarter: 1, stats: {} };
    let plotLibrary = [];
    let usedPlotIds = new Set(); 

    window.onload = async function() {
        try {
            const response = await fetch(CSV_URL);
            const buffer = await response.arrayBuffer();
            const text = new TextDecoder('utf-8').decode(buffer);
            parseCSV(text);
            document.getElementById('loading-overlay').classList.add('hidden');
        } catch (err) { document.getElementById('load-status').innerText = "åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥CSV"; }
    };

    function parseCSV(text) {
        const rows = text.split(/\r?\n/).filter(line => line.trim() !== "");
        let startIndex = rows[0].includes("ID") ? 0 : 1;
        const dataRows = rows.slice(startIndex + 1); 
        plotLibrary = dataRows.map(row => {
            const cols = row.split(',');
            if (cols.length < 28) return null; 
            return {
                id: cols[0].trim(), rank: cols[1].trim(), year: parseInt(cols[2]),
                title: cols[4], text: cols[5],
                choices: [
                    { 
                        text: cols[6], checkAttr: cols[7].trim(), checkVal: parseInt(cols[8]),
                        resOk: cols[9], resFail: cols[10],
                        stats: { beauty: +cols[11], talent: +cols[12], wit: +cols[13], body: +cols[14], prestige: +cols[15], favor: +cols[16] },
                        newRank: cols[17].trim()
                    },
                    { 
                        text: cols[18], checkAttr: cols[19].trim(), checkVal: parseInt(cols[20]),
                        resOk: cols[21], resFail: cols[22],
                        stats: { beauty: +cols[23], talent: +cols[24], wit: +cols[25], body: +cols[26], prestige: +cols[27], favor: +cols[28] || 0 },
                        newRank: cols[29] ? cols[29].trim() : ""
                    }
                ]
            };
        }).filter(i => i);
    }

    function generateIdentity() {
        const nameInput = document.getElementById('p-name').value;
        if (!nameInput) return alert("è¯·èµå");
        p.name = nameInput;
        const ranks = ["å®«å¥³", "ç­”åº”", "è´µäºº"];
        p.rank = ranks[Math.floor(Math.random() * 3)]; 
        const base = { "å®«å¥³":[20,40], "ç­”åº”":[35,55], "è´µäºº":[50,70] }[p.rank];
        let initFavor = p.rank === "å®«å¥³" ? 0 : rnd(1, 10);
        p.stats = { beauty: rnd(base[0],base[1]), talent: rnd(base[0],base[1]), wit: rnd(base[0],base[1]), body: rnd(40,60), prestige: rnd(5,15), favor: initFavor };
        
        document.getElementById('page-start').classList.add('hidden');
        document.getElementById('page-identity').classList.remove('hidden');
        document.getElementById('display-rank').innerText = `${p.name} Â· ${p.rank}`;
        document.getElementById('display-stats').innerHTML = `å®¹è²Œï¼š${p.stats.beauty} &nbsp; æ‰æƒ…ï¼š${p.stats.talent}<br>å¿ƒæœºï¼š${p.stats.wit} &nbsp; ä½“è´¨ï¼š${p.stats.body}<br>å£°æœ›ï¼š${p.stats.prestige} &nbsp; åœ£å® ï¼š${p.stats.favor}`;
    }

    function rnd(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    function enterPalace() {
        document.getElementById('page-identity').classList.add('hidden');
        document.getElementById('page-game').classList.remove('hidden');
        document.getElementById('menu-trigger').classList.remove('hidden');
        document.getElementById('stat-panel').classList.add('active');
        updateStatPanel();
        showPlot();
    }

    function resistDecree() {
        document.getElementById('identity-content').innerHTML = `
            <div class="dead-card">
                <h2 style="letter-spacing: 5px;">é›·éœ†ä¹‹æ€’</h2>
                <div style="line-height:1.8; margin:20px 0;">å¤§èƒ† ${p.name}ï¼åœ£æ—¨å·²ä¸‹ç«Ÿç„¶æŠ—æ—¨ä¸å°Šï¼Ÿ<br>çš‡ä¸Šé¾™é¢œå¤§æ€’ï¼Œä¸‹æ—¨å°†ä½ æ»¡é—¨æŠ„æ–©ï¼Œè¯›ä¹æ—ï¼</div>
                <button class="choice-btn" style="background:#400; color:#fff; border:none;" onclick="location.reload()">é‡æ–°å¼€å§‹</button>
            </div>`;
    }

    function toggleStats() { document.getElementById('stat-panel').classList.toggle('open'); }

    function updateStatPanel() {
        document.getElementById('stat-content').innerHTML = `
            <div class="stat-row">ä½ä»½ï¼š${p.rank}</div>
            <div class="stat-row">æ—¶é—´ï¼šç¬¬${p.year}å¹´ å­£${p.quarter}</div>
            <div class="stat-row">åœ£å® ï¼š<span style="color:#ff4d4d">${p.stats.favor}</span></div>
            <div class="stat-row">å£°æœ›ï¼š${p.stats.prestige}</div>
            <div class="stat-row">å®¹è²Œï¼š${p.stats.beauty}</div>
            <div class="stat-row">æ‰æƒ…ï¼š${p.stats.talent}</div>
            <div class="stat-row">å¿ƒæœºï¼š${p.stats.wit}</div>
            <div class="stat-row">ä½“è´¨ï¼š${p.stats.body}</div>
        `;
    }

    function showPlot() {
        // ç‰¹æ®Šé€»è¾‘ï¼šä»…å®«å¥³æœ‰5å¹´å¤§é™
        if (p.rank === "å®«å¥³" && p.year >= 6) {
            showEnding("å‡ºå®«æ©å…¸", "å…¥å®«äº”è½½ï¼Œä½ ä¾æ—§åªæ˜¯ä¸ªå‘å¾®çš„å®«å¥³ã€‚å¦‚ä»Šé’æ˜¥å·²é€ï¼Œå¬·å¬·æŒ‰ä¾‹å°†ä½ æ”¾å‡ºå®«å»ã€‚å›åˆ°å®¶åï¼Œçˆ¶æ¯ä¸ºä½ å¯»äº†ä¸€æˆ·è¸å®äººå®¶ï¼Œä½ ä»æ­¤æ´—å°½é“…åï¼Œè¿‡ä¸Šäº†å¹³æ·¡çš„ä¸€ç”Ÿã€‚");
            return;
        }

        let candidates = plotLibrary.filter(item => item.rank === p.rank && item.year === p.year && !usedPlotIds.has(item.id));
        if (candidates.length === 0) {
            usedPlotIds.clear(); 
            candidates = plotLibrary.filter(item => item.rank === p.rank && item.year === p.year);
        }
        let s = candidates[Math.floor(Math.random() * candidates.length)];
        
        if (!s) s = { title: "æ·±å®«ç‹¬å¤„", text: "è¿™ä¸€å­£å®«ä¸­æ— äº‹ã€‚", choices: [{ text: "ç»§ç»­", resOk: "å²æœˆé™å¥½ã€‚", stats: {} }] };
        else usedPlotIds.add(s.id);

        document.getElementById('story-text').innerHTML = `<strong>ã€${s.title}ã€‘</strong><br>${s.text}`;
        const area = document.getElementById('choices-area'); area.innerHTML = "";
        
        s.choices.forEach(c => {
            if(!c.text) return;
            let btn = document.createElement('button'); btn.className = "choice-btn"; btn.innerText = c.text;
            btn.onclick = () => {
                let pass = true;
                if(c.checkAttr && c.checkAttr !== "æ— ") {
                    const attrKeyMap = {"å®¹è²Œ":"beauty","æ‰æƒ…":"talent","å¿ƒæœº":"wit","ä½“è´¨":"body","å£°æœ›":"prestige","åœ£å® ":"favor"};
                    let key = attrKeyMap[c.checkAttr] || c.checkAttr;
                    if(p.stats[key] < c.checkVal) pass = false;
                }
                
                if(pass) {
                    for(let k in c.stats) p.stats[k] += (c.stats[k] || 0);
                    // åªè¦CSVâ€œæ™‹å‡â€åˆ—å†™â€œç»“å±€â€ï¼Œå°±èµ°æˆåŠŸé€šå…³é€»è¾‘
                    if (c.newRank === "ç»“å±€") {
                        showEnding("å°˜åŸƒè½å®š", c.resOk);
                        return;
                    }
                    if(c.newRank && c.newRank !== "") p.rank = c.newRank;
                    p.quarter++; if(p.quarter>4){p.quarter=1; p.year++;}
                    updateStatPanel();
                    document.getElementById('story-text').innerHTML = `<div class="message">${c.resOk}</div>`;
                    area.innerHTML = `<button class="choice-btn" onclick="showPlot()">ç»§ç»­</button>`;
                } else {
                    gameOver(c.resFail || "ä½ æœªèƒ½é€šè¿‡è€ƒéªŒï¼Œæƒ¨æ­»å®«ä¸­ã€‚");
                }
            };
            area.appendChild(btn);
        });
    }

    function showEnding(title, msg) {
        document.getElementById('page-game').innerHTML = `
            <div class="end-card">
                <h2 style="color:var(--palace-red); letter-spacing: 5px;">${title}</h2>
                <div style="line-height:1.8; margin:20px 0; color:var(--ink);">${msg}</div>
                <hr style="border:0; border-top:1px solid var(--gold); margin:20px 0;">
                <p style="font-size:0.9rem; color:var(--gold);">â€”â€” å†ç»é£éœœï¼Œç»ˆå¾—æ­£æœ â€”â€”</p>
                <button class="choice-btn" onclick="location.reload()">å†å…¥è½®å›</button>
            </div>`;
    }

    function gameOver(res) {
        document.getElementById('page-game').innerHTML = `
            <div class="dead-card">
                <h2 style="letter-spacing: 5px;">é­‚æ–­æ·±å®«</h2>
                <div style="line-height:1.8; margin:20px 0;">${res}</div>
                <hr style="border:0; border-top:1px solid #600; margin:20px 0;">
                <button class="choice-btn" style="background:#400; color:#fff; border:none;" onclick="location.reload()">é‡æ–°å¼€å§‹</button>
            </div>`;
        document.getElementById('menu-trigger').classList.add('hidden');
    }
</script>
</body>
</html>
