<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>深宫华章 - 适配版</title>
    <style>
        :root { --palace-red: #8b1b1b; --gold: #c5a059; --paper: #f4f1de; --ink: #2c2c2c; --success-bg: #fffafa; }
        body { margin: 0; padding: 0; background-color: #1a1a1a; font-family: "STKaiti", "KaiTi", serif; height: 100vh; width: 100vw; overflow: hidden; }
        
        #game-container { 
            width: 100%; height: 100%; max-width: 600px; margin: 0 auto; 
            background: var(--paper) url('https://www.transparenttextures.com/patterns/paper-fibers.png'); 
            border: 4px solid var(--palace-red); outline: 2px solid var(--gold); outline-offset: -4px; 
            position: relative; display: flex; flex-direction: column; box-sizing: border-box; 
        }

        header { background: var(--palace-red); color: var(--gold); padding: 15px 0; text-align: center; font-size: 1.4rem; letter-spacing: 5px; border-bottom: 4px double var(--gold); flex-shrink: 0; }
        #scene { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        #stat-panel { position: absolute; right: -100%; top: 0; width: 100%; max-width: 400px; height: 100%; background: rgba(139, 27, 27, 0.98); color: var(--gold); transition: right 0.4s ease; z-index: 100; padding: 40px 20px; box-sizing: border-box; border-left: 3px solid var(--gold); }
        #stat-panel.open { right: 0; }

        .message { background: rgba(255,255,255,0.6); padding: 20px; border: 1px solid var(--gold); line-height: 1.7; color: var(--ink); font-size: 1.1rem; margin-bottom: 20px; }
        .choice-btn { background: white; color: var(--palace-red); border: 1px solid var(--palace-red); padding: 15px; margin-bottom: 12px; cursor: pointer; font-family: "STKaiti", serif; font-size: 1.1rem; transition: 0.2s; box-shadow: 2px 2px 0 var(--gold); width: 100%; box-sizing: border-box; }
        .choice-btn:active { background: #f0f0f0; }
        
        .btn-death { color: #fff; background: #600; border-color: #000; box-shadow: 2px 2px 0 #300; }

        #page-start { height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        input[type="text"] { background: transparent; border: none; border-bottom: 2px solid var(--palace-red); width: 80%; padding: 10px; font-size: 1.3rem; text-align: center; margin: 30px 0; outline: none; font-family: "STKaiti", serif; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="loading-overlay" style="position: absolute; top:0; left:0; width:100%; height:100%; background:var(--paper); z-index:1000; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div id="load-status" style="font-size: 1.2rem; color: var(--palace-red);">正在同步云端档案...</div>
    </div>
    
    <header>深宫华章</header>
    
    <div id="stat-panel">
        <h2 style="text-align:center;">个人档籍</h2>
        <div id="stat-content"></div>
        <button class="choice-btn" onclick="toggleStats()">收回档籍</button>
    </div>

    <div id="scene">
        <div id="page-start">
            <h1 style="color: var(--palace-red); letter-spacing: 10px;">百花齐放</h1>
            <input type="text" id="p-name" placeholder="请输入芳名">
            <button class="choice-btn" style="width: 200px;" onclick="generateIdentity()">求取签文</button>
        </div>

        <div id="page-identity" class="hidden">
            <div class="message" style="text-align: center;">选秀呈报，资料如下：</div>
            <div style="border: 2px solid var(--palace-red); padding: 15px; background: #fffafa; text-align: center; margin-bottom: 20px;">
                <h2 id="display-rank" style="color: var(--palace-red); margin: 0;"></h2>
                <div id="display-stats" style="margin-top: 10px; text-align: left; display: inline-block; line-height: 1.8;"></div>
            </div>
            <button class="choice-btn" onclick="enterPalace()">领旨入宫</button>
            <button class="choice-btn btn-death" onclick="rejectOrder()">抗旨不尊</button>
        </div>

        <div id="page-game" class="hidden">
            <div id="story-text" class="message"></div>
            <div id="choices-area"></div>
            <div onclick="toggleStats()" style="text-align:center; color:var(--palace-red); cursor:pointer; margin-top:10px;">[ 查看档籍 ]</div>
        </div>
    </div>
</div>

<script>
    // 修正后的 CSV 地址
    const CSV_URL = 'https://raw.githubusercontent.com/brorobooo/palace-game/main/plot.csv';
    
    let p = { name: "", rank: "", dynasty: "", gameYear: 1, quarter: 1, stats: {} };
    let plotLibrary = [];

    window.onload = async function() {
        try {
            const response = await fetch(CSV_URL);
            const text = await response.text();
            parseCSV(text);
            document.getElementById('loading-overlay').classList.add('hidden');
        } catch (err) { 
            document.getElementById('load-status').innerText = "加载档案失败，请检查网络或路径"; 
        }
    };

    function parseCSV(text) {
        const rows = text.split(/\r?\n/).filter(line => line.trim() !== "");
        plotLibrary = rows.slice(1).map(row => {
            const c = row.split(',');
            if (c.length < 10) return null;
            return {
                id: c[0], rank: c[1].trim(), title: c[4], text: c[5],
                choices: [
                    { txt: c[6], attr: c[7], val: parseInt(c[8]), okMsg: c[9], up: { favor: +c[16], prestige: +c[15] }, jump: c[17]?.trim() },
                    { txt: c[18], attr: c[19], val: parseInt(c[20]), okMsg: c[21], up: { favor: +c[28], prestige: +c[27] }, jump: c[29]?.trim() }
                ]
            };
        }).filter(i => i);
    }

    function generateIdentity() {
        p.name = document.getElementById('p-name').value || "无名氏";
        const ranks = ["宫女", "答应", "贵人"];
        p.rank = ranks[Math.floor(Math.random() * ranks.length)];
        
        // 初始属性初始化
        p.stats = { beauty: 40, talent: 40, wit: 40, body: 70, prestige: 10, favor: (p.rank === "宫女" ? 0 : 10) };
        
        document.getElementById('page-start').classList.add('hidden');
        document.getElementById('page-identity').classList.remove('hidden');
        document.getElementById('display-rank').innerText = `${p.name} · ${p.rank}`;
        document.getElementById('display-stats').innerHTML = `初始位份：${p.rank}<br>初始圣宠：${p.stats.favor}`;
    }

    function rejectOrder() {
        document.getElementById('page-identity').innerHTML = `
            <div style="background:#000; color:red; padding:40px; text-align:center; height:100%;">
                <h1>大逆不道</h1>
                <p>天子之命，岂容尔等拒绝？</p>
                <p>圣上震怒，下旨：将${p.name}九族尽数捉拿，午门斩首，以此谢罪！</p>
                <button class="choice-btn" style="margin-top:50px" onclick="location.reload()">重新投胎</button>
            </div>`;
    }

    function enterPalace() {
        document.getElementById('page-identity').classList.add('hidden');
        document.getElementById('page-game').classList.remove('hidden');
        showPlot();
    }

    function showPlot() {
        // 宫女五年强制结局逻辑
        if (p.rank === "宫女" && p.gameYear > 5) {
            document.getElementById('page-game').innerHTML = `
                <div class="message" style="text-align:center;">
                    <h2>出宫结局：相夫教子</h2>
                    <p>五年光阴弹指一挥间。由于一直未能获得圣眷晋升，你年满被遣返原籍。</p>
                    <p>家中父母为你寻得一门普通亲事。你从此洗尽铅华，相夫教子，平凡一生。</p>
                    <button class="choice-btn" onclick="location.reload()">再入轮回</button>
                </div>`;
            return;
        }

        // 识别 CSV 中的内容（关键：匹配 p.rank）
        let list = plotLibrary.filter(i => i.rank === p.rank);
        if (list.length === 0) {
            document.getElementById('story-text').innerText = `（未在 CSV 中找到位份为 [${p.rank}] 的剧情，请检查表格内容）`;
            return;
        }

        let s = list[Math.floor(Math.random() * list.length)];
        document.getElementById('story-text').innerHTML = `<strong>【${s.title}】</strong><br>${s.text}`;
        
        const area = document.getElementById('choices-area');
        area.innerHTML = "";
        s.choices.forEach(c => {
            if (!c.txt) return;
            let btn = document.createElement('button');
            btn.className = "choice-btn";
            btn.innerText = c.txt;
            btn.onclick = () => {
                // 简单的成功判定逻辑
                p.stats.favor += (c.up.favor || 0);
                if (c.jump && c.jump !== "无") p.rank = c.jump;
                
                p.quarter++;
                if (p.quarter > 4) { p.quarter = 1; p.gameYear++; }
                
                document.getElementById('story-text').innerText = c.okMsg;
                area.innerHTML = `<button class="choice-btn" onclick="showPlot()">继续</button>`;
            };
            area.appendChild(btn);
        });
    }

    function toggleStats() {
        const panel = document.getElementById('stat-panel');
        if (!panel.classList.contains('open')) {
            document.getElementById('stat-content').innerHTML = `
                <p>姓名：${p.name}</p>
                <p>位份：${p.rank}</p>
                <p>入宫第 ${p.gameYear} 年</p>
                <p>圣宠：${p.stats.favor}</p>
                <p>声望：${p.stats.prestige}</p>
            `;
        }
        panel.classList.toggle('open');
    }
</script>
</body>
</html>
