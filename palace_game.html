<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ·±å®«åç«  - ç››ä¸–ä½™æ™–ç‰ˆâ¥(^_-)</title>
    <style>
        :root { --palace-red: #8b1b1b; --gold: #c5a059; --paper: #f4f1de; --ink: #2c2c2c; --success-bg: #fffafa; }
        body { margin: 0; padding: 0; background-color: #1a1a1a; font-family: "STKaiti", "KaiTi", serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow-y: auto; }
        #game-container { width: 95%; max-width: 500px; height: auto; min-height: 85vh; max-height: 95vh; background: var(--paper) url('https://www.transparenttextures.com/patterns/paper-fibers.png'); border: 6px solid var(--palace-red); outline: 2px solid var(--gold); outline-offset: -4px; position: relative; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.7); margin: 20px 0; }
        header { background: var(--palace-red); color: var(--gold); padding: 12px 0; text-align: center; font-size: 1.4rem; letter-spacing: 5px; border-bottom: 4px double var(--gold); z-index: 5; flex-shrink: 0; }
        #scene { flex-grow: 1; padding: 20px 20px 40px 20px; display: flex; flex-direction: column; z-index: 4; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        #stat-panel { position: absolute; right: -100%; top: 0; width: 85%; height: 100%; background: rgba(139, 27, 27, 0.98); color: var(--gold); transition: right 0.4s ease; z-index: 100; padding: 40px 20px; box-sizing: border-box; border-left: 3px solid var(--gold); }
        #stat-panel.open { right: 0; }
        .stat-row { margin-bottom: 10px; border-bottom: 1px solid rgba(197, 160, 89, 0.3); padding: 5px 0; font-size: 1rem; display: flex; justify-content: space-between; }
        #menu-trigger { position: absolute; bottom: 15px; right: 15px; width: 50px; height: 50px; background: var(--gold); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 24px; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.4); z-index: 101; }
        .message { background: rgba(255,255,255,0.6); padding: 20px; border: 1px solid var(--gold); line-height: 1.7; color: var(--ink); font-size: 1.1rem; margin-bottom: 20px; }
        .choice-btn { background: white; color: var(--palace-red); border: 1px solid var(--palace-red); padding: 12px; margin-bottom: 10px; cursor: pointer; font-family: "STKaiti", serif; font-size: 1rem; transition: 0.2s; box-shadow: 2px 2px 0 var(--gold); width: 100%; box-sizing: border-box; }
        .choice-btn:active { transform: scale(0.98); background: #eee; }
        .hidden { display: none !important; }
        input[type="text"] { background: transparent; border: none; border-bottom: 2px solid var(--palace-red); width: 70%; padding: 10px; font-size: 1.2rem; text-align: center; margin: 20px 0; outline: none; font-family: "STKaiti", serif; }
        .end-card { border: 4px double var(--gold); background: var(--success-bg); padding: 25px; text-align: center; }
        .dead-card { border: 4px solid #600; background: #1a0000; color: #ff4d4d; padding: 25px; text-align: center; min-height: 50%; display: flex; flex-direction: column; justify-content: center; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="loading-overlay" style="position: absolute; top:0; left:0; width:100%; height:100%; background:var(--paper); z-index:1000; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div id="load-status" style="font-size: 1.2rem; color: var(--palace-red);">æ­£åœ¨æ•´ç†å·å®—...</div>
    </div>
    <header>æ·±å®«åç« </header>
    <div id="stat-panel">
        <h2 style="text-align:center; letter-spacing: 5px; border-bottom: 2px solid var(--gold); padding-bottom: 10px;">ä¸ªäººæ¡£ç±</h2>
        <div id="stat-content"></div>
        <button class="choice-btn" style="margin-top:30px;" onclick="toggleStats()">æ”¶å›æ¡£ç±</button>
    </div>
    <div id="menu-trigger" class="hidden" onclick="toggleStats()">ğŸ®</div>
    <div id="scene">
        <div id="page-start" style="text-align: center; margin-top: 40px;">
            <h1 style="color: var(--palace-red); letter-spacing: 10px;">ç™¾èŠ±é½æ”¾</h1>
            <input type="text" id="p-name" placeholder="è¯·è¾“å…¥èŠ³å">
            <br>
            <button class="choice-btn" style="width: 200px; font-size: 1.2rem;" onclick="generateIdentity()">æ±‚å–ç­¾æ–‡</button>
        </div>
        <div id="page-identity" class="hidden">
            <div id="identity-content">
                <div class="message" style="text-align: center;">é€‰ç§€å‘ˆæŠ¥ï¼Œèµ„æ–™å¦‚ä¸‹ï¼š</div>
                <div style="border: 2px solid var(--palace-red); padding: 15px; background: #fffafa; text-align: center; margin-bottom: 15px;">
                    <h2 id="display-rank" style="color: var(--palace-red); margin: 0; font-size: 1.4rem;"></h2>
                    <div id="display-stats" style="margin-top: 10px; text-align: left; display: inline-block; line-height: 1.8; font-size: 0.95rem;"></div>
                </div>
                <button class="choice-btn" onclick="enterPalace()">é¢†æ—¨å…¥å®«</button>
            </div>
        </div>
        <div id="page-game" class="hidden">
            <div id="story-text" class="message"></div>
            <div id="choices-area"></div>
        </div>
    </div>
</div>

<script>
    const CSV_URL = 'https://raw.githubusercontent.com/brorobooo/palace-game/main/plot.csv';
    const DYNASTIES = ["å´‡ç››", "æ³°å®‰", "æ™¯å’Œ", "å…ƒç¦§", "æ°¸ç¦", "å¾·æ¶¦", "é–å¹³", "å˜‰ç¦", "ç¿å®", "ç†™å¾·"];
    
    let p = { 
        name: "", rank: "", dynasty: "", startYear: 1, gameYear: 1, quarter: 1, 
        emperorDeathYear: 30, 
        stats: { beauty: 0, talent: 0, wit: 0, body: 0, prestige: 0, favor: 0 } 
    };
    
    let plotLibrary = [];

    window.onload = async function() {
        try {
            const response = await fetch(CSV_URL);
            const text = await response.text();
            parseCSV(text);
            document.getElementById('loading-overlay').classList.add('hidden');
        } catch (err) { document.getElementById('load-status').innerText = "åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"; }
    };

    function parseCSV(text) {
        const rows = text.split(/\r?\n/).filter(line => line.trim() !== "");
        const dataRows = rows.slice(1); 
        plotLibrary = dataRows.map(row => {
            const c = row.split(',');
            if (c.length < 31) return null; 
            return {
                id: c[0], rank: c[1].trim(), title: c[4], text: c[5],
                choices: [
                    {
                        txt: c[6], attr: c[7], val: parseInt(c[8]), okMsg: c[9], failMsg: c[10],
                        up: { beauty: +c[11], talent: +c[12], wit: +c[13], body: +c[14], prestige: +c[15], favor: +c[16] },
                        jump: c[17].trim()
                    },
                    {
                        txt: c[18], attr: c[19], val: parseInt(c[20]), okMsg: c[21], failMsg: c[22],
                        up: { beauty: +c[23], talent: +c[24], wit: +c[25], body: +c[26], prestige: +c[27], favor: +c[28] },
                        jump: c[29].trim()
                    }
                ]
            };
        }).filter(i => i);
    }

    function rnd(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    function generateIdentity() {
        const nameInput = document.getElementById('p-name').value;
        if (!nameInput) return alert("è¯·èµå");
        p.name = nameInput;
        p.dynasty = DYNASTIES[rnd(0, DYNASTIES.length - 1)];
        p.startYear = rnd(1, 15);
        p.emperorDeathYear = p.startYear + rnd(10, 20); 
        
        const ranks = ["å®«å¥³", "ç­”åº”", "è´µäºº"];
        p.rank = ranks[rnd(0, 2)];
        
        // å®«å¥³åˆå§‹å±æ€§åŠåœ£å® åˆ¤å®š
        if(p.rank === "å®«å¥³") {
            p.stats = { beauty: rnd(30, 50), talent: rnd(30, 50), wit: rnd(30, 50), body: rnd(60, 80), prestige: rnd(0, 5), favor: 0 };
        } else {
            p.stats = { beauty: rnd(40, 70), talent: rnd(40, 70), wit: rnd(40, 70), body: rnd(50, 80), prestige: rnd(10, 20), favor: rnd(0, 10) };
        }
        
        document.getElementById('page-start').classList.add('hidden');
        document.getElementById('page-identity').classList.remove('hidden');
        document.getElementById('display-rank').innerText = `${p.name} Â· ${p.rank}`;
        document.getElementById('display-stats').innerHTML = `
            å¹´å·ï¼š${p.dynasty}${p.startYear}å¹´<br>
            å®¹è²Œï¼š${p.stats.beauty} &nbsp; æ‰æƒ…ï¼š${p.stats.talent}<br>
            å¿ƒæœºï¼š${p.stats.wit} &nbsp; ä½“è´¨ï¼š${p.stats.body}
        `;
    }

    function enterPalace() {
        document.getElementById('page-identity').classList.add('hidden');
        document.getElementById('page-game').classList.remove('hidden');
        document.getElementById('menu-trigger').classList.remove('hidden');
        updateStatPanel();
        showPlot();
    }

    function updateStatPanel() {
        let curY = p.startYear + p.gameYear - 1;
        document.getElementById('stat-content').innerHTML = `
            <div class="stat-row"><span>ä½ä»½ï¼š</span><span>${p.rank}</span></div>
            <div class="stat-row"><span>æ—¶é—´ï¼š</span><span>${p.dynasty}${curY}è½½ (${p.quarter}å­£)</span></div>
            <div class="stat-row"><span>å®¹è²Œï¼š</span><span>${p.stats.beauty}</span></div>
            <div class="stat-row"><span>æ‰æƒ…ï¼š</span><span>${p.stats.talent}</span></div>
            <div class="stat-row"><span>å¿ƒæœºï¼š</span><span>${p.stats.wit}</span></div>
            <div class="stat-row"><span>ä½“è´¨ï¼š</span><span>${p.stats.body}</span></div>
            <div class="stat-row"><span>åœ£å® ï¼š</span><span>${p.stats.favor}</span></div>
            <div class="stat-row"><span>å£°æœ›ï¼š</span><span>${p.stats.prestige}</span></div>
        `;
    }

    function showPlot() {
        let curY = p.startYear + p.gameYear - 1;

        // åˆ¤å®šå®«å¥³äº”å¹´æœªæ™‹å‡ç»“å±€
        if (p.rank === "å®«å¥³" && p.gameYear > 5) {
            showEnd("é£æ•£å‡ºå®«", "äº”å¹´æœŸæ»¡ï¼Œä½ ç»ˆç©¶åªæ˜¯ä¸€åå¹³å‡¡å®«å¥³ã€‚æŒ‰å¾‹é£æ•£å‡ºå®«åï¼Œçˆ¶æ¯ä¸ºä½ å¯»äº†ä¸€æˆ·è€å®äººå®¶ï¼Œä»æ­¤ç›¸å¤«æ•™å­ï¼Œå¹³æ·¡ä¸€ç”Ÿã€‚");
            return;
        }

        if (curY >= p.emperorDeathYear) { handleDeath(); return; }

        let list = plotLibrary.filter(i => i.rank === p.rank);
        let s = list[rnd(0, list.length - 1)] || { title: "æ·±å®«å²æœˆ", text: "è¿™ä¸€å­£å®«ä¸­å¹³å’Œã€‚", choices: [{txt: "ç»§ç»­", okMsg: "æ—¶å…‰æµé€ã€‚", up: {}}] };

        document.getElementById('story-text').innerHTML = `<strong>ã€${s.title}ã€‘</strong><br>${s.text}`;
        const area = document.getElementById('choices-area'); area.innerHTML = "";

        s.choices.forEach(c => {
            if (!c.txt) return;
            let btn = document.createElement('button'); btn.className = "choice-btn"; btn.innerText = c.txt;
            btn.onclick = () => {
                const attrMap = {"å®¹è²Œ":"beauty","æ‰æƒ…":"talent","å¿ƒæœº":"wit","ä½“è´¨":"body","å£°æœ›":"prestige","åœ£å® ":"favor"};
                let key = attrMap[c.attr];
                if (key && p.stats[key] < c.val) {
                    gameOver(c.failMsg || "ä½ ç»ˆç©¶æ£‹å·®ä¸€æ‹›ã€‚"); return;
                }
                
                for (let k in c.up) p.stats[k] += c.up[k];
                
                if (c.jump && c.jump !== "æ— ") p.rank = c.jump;
                p.quarter++; if (p.quarter > 4) { p.quarter = 1; p.gameYear++; }
                updateStatPanel();
                document.getElementById('story-text').innerHTML = `<div class="message">${c.okMsg}</div>`;
                area.innerHTML = `<button class="choice-btn" onclick="showPlot()">ç»§ç»­</button>`;
            };
            area.appendChild(btn);
        });
    }

    function handleDeath() {
        let title = "å¤§è¡Œçš‡å¸é©¾å´©", msg = "";
        let r = p.rank;

        if (r === "çš‡å") {
            title = "æ¯åçš‡å¤ªå"; msg = "æ–°å¸ç™»åŸºï¼Œå°Šä½ ä¸ºæ¯åçš‡å¤ªåã€‚ä½ ç¨³å±…æ…ˆå®å®«ï¼Œä¸»æŒåå®«äº‹åŠ¡ï¼Œå®‰äº«æ— ä¸Šå°Šè£ã€‚";
        } else if (r === "è´µå¦ƒ") {
            title = "å®‰äº«å°Šè£"; msg = "æ–°å¸æ„Ÿå¿µä½ çš„èº«ä»½ï¼Œå°Šä½ ä¸ºçš‡å¤ªå¦ƒã€‚ä½ åœ¨å®«ä¸­å®‰äº«è£åï¼Œæ— äººæ•¢è½»æ˜“å†’çŠ¯ã€‚";
        } else if (r.includes("å¦ƒ")) {
            title = "å¾·é«˜æœ›é‡"; msg = "æ–°å¸å°Šä½ ä¸ºçš‡å¤ªå¦ƒï¼Œè®©ä½ åœ¨å®«ä¸­é¢å…»å¤©å¹´ã€‚è™½å¤±å»äº†å¾€æ—¥æƒåŠ¿ï¼Œå€’ä¹Ÿå®‰ç¨³ã€‚";
        } else if (r === "è´µäºº") {
            title = "ä½›å ‚æ¸…ä¿®"; msg = "ä½ è¯·æ—¨å‰å¾€çš‡å®¶å¯ºé™¢å¸¦å‘ä¿®è¡Œã€‚æ¯æ—¥è¯µç»ç¤¼ä½›ï¼Œè¿œç¦»å®«å»·çº·äº‰ï¼Œæ¸…å¿ƒå¯¡æ¬²ã€‚";
        } else { // ç­”åº”æˆ–å®«å¥³
            title = "å®ˆé™µç»ˆè€"; msg = "ä½œä¸ºä½ä½å«”å¦ƒï¼Œä½ è¢«å®‰æ’å‰å¾€çš‡å®¶é™µå¯å®ˆé™µã€‚é’ç¯å¤ä½›ï¼Œæ­¤ç”Ÿä¸ç¹åéš”ç»ã€‚";
        }

        showEnd(title, msg);
    }

    function showEnd(title, msg) {
        document.getElementById('page-game').innerHTML = `
            <div class="end-card"><h2>${title}</h2><p>${msg}</p><button class="choice-btn" onclick="location.reload()">å†å…¥è½®å›</button></div>`;
    }

    function gameOver(m) {
        document.getElementById('page-game').innerHTML = `
            <div class="dead-card"><h2>é­‚æ–­æ·±å®«</h2><p>${m}</p><button class="choice-btn" onclick="location.reload()">é‡æ–°å¼€å§‹</button></div>`;
    }

    function toggleStats() { document.getElementById('stat-panel').classList.toggle('open'); }
</script>
</body>
</html>

