<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ·±å®«åç«  - å‘½é€”ä¸ä¼ æ‰¿ç‰ˆ</title>
    <style>
        :root { --palace-red: #8b1b1b; --gold: #c5a059; --paper: #f4f1de; --ink: #2c2c2c; }
        body { margin: 0; padding: 0; background-color: #1a1a1a; font-family: "STKaiti", "KaiTi", serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow-y: auto; }
        #game-container { width: 95%; max-width: 500px; min-height: 85vh; max-height: 95vh; background: var(--paper) url('https://www.transparenttextures.com/patterns/paper-fibers.png'); border: 6px solid var(--palace-red); outline: 2px solid var(--gold); outline-offset: -4px; position: relative; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.7); margin: 20px 0; }
        header { background: var(--palace-red); color: var(--gold); padding: 12px 0; text-align: center; font-size: 1.4rem; letter-spacing: 5px; border-bottom: 4px double var(--gold); z-index: 5; flex-shrink: 0; }
        #scene { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; z-index: 4; overflow-y: auto; }
        #stat-panel { position: absolute; right: -100%; top: 0; width: 85%; height: 100%; background: rgba(139, 27, 27, 0.98); color: var(--gold); transition: right 0.4s ease; z-index: 100; padding: 40px 20px; box-sizing: border-box; border-left: 3px solid var(--gold); }
        #stat-panel.open { right: 0; }
        .stat-row { margin-bottom: 10px; border-bottom: 1px solid rgba(197, 160, 89, 0.3); padding: 5px 0; font-size: 1rem; }
        #menu-trigger { position: absolute; bottom: 15px; right: 15px; width: 50px; height: 50px; background: var(--gold); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 24px; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.4); z-index: 101; }
        .message { background: rgba(255,255,255,0.6); padding: 20px; border: 1px solid var(--gold); line-height: 1.7; color: var(--ink); font-size: 1.1rem; margin-bottom: 20px; }
        .choice-btn { background: white; color: var(--palace-red); border: 1px solid var(--palace-red); padding: 12px; margin-bottom: 10px; cursor: pointer; font-family: "STKaiti", serif; width: 100%; box-sizing: border-box; font-size: 1rem; transition: 0.2s; box-shadow: 2px 2px 0 var(--gold); }
        .choice-btn:active { transform: scale(0.98); }
        .hidden { display: none !important; }
        input[type="text"] { background: transparent; border: none; border-bottom: 2px solid var(--palace-red); width: 70%; padding: 10px; font-size: 1.2rem; text-align: center; margin: 20px 0; outline: none; font-family: "STKaiti", serif; }
        .end-card { border: 4px double var(--gold); background: #fffafa; padding: 25px; text-align: center; }
        .dead-card { border: 4px solid #600; background: #1a0000; color: #ff4d4d; padding: 25px; text-align: center; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="loading-overlay" style="position: absolute; top:0; left:0; width:100%; height:100%; background:var(--paper); z-index:1000; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div id="load-status">æ­£åœ¨å¼€å¯å®«é—¨...</div>
    </div>
    <header>æ·±å®«åç« </header>
    <div id="stat-panel">
        <h2 style="text-align:center; border-bottom: 2px solid var(--gold);">ä¸ªäººæ¡£ç±</h2>
        <div id="stat-content"></div>
        <button class="choice-btn" style="margin-top:30px;" onclick="toggleStats()">æ”¶å›æ¡£ç±</button>
    </div>
    <div id="menu-trigger" class="hidden" onclick="toggleStats()">ğŸ®</div>
    <div id="scene">
        <div id="page-start" style="text-align: center; margin-top: 40px;">
            <h1 style="color: var(--palace-red);">ç™¾èŠ±äº‰è‰³</h1>
            <input type="text" id="p-name" placeholder="è¯·è¾“å…¥èŠ³å">
            <br><br>
            <button class="choice-btn" style="width: 200px;" onclick="generateIdentity()">è¸å…¥å®«é—¨</button>
        </div>
        <div id="page-game" class="hidden">
            <div id="story-text" class="message"></div>
            <div id="choices-area"></div>
        </div>
    </div>
</div>

<script>
    const CSV_URL = 'https://raw.githubusercontent.com/brorobooo/palace-game/main/plot.csv';
    const DYNASTIES = ["å´‡ç››", "æ³°å®‰", "æ™¯å’Œ", "å…ƒç¦§", "æ°¸ç¦", "å¾·æ¶¦", "é–å¹³", "å˜‰ç¦", "ç¿å®", "ç†™å¾·"];
    
    let p = { 
        name: "", rank: "", dynasty: "", startYear: 1, gameYear: 1, quarter: 1, 
        emperorDeathYear: 30, children: { son: 0, daughter: 0 }, stats: {} 
    };
    
    let plotLibrary = [];

    window.onload = async () => {
        try {
            const res = await fetch(CSV_URL);
            const text = await res.text();
            parseCSV(text);
            document.getElementById('loading-overlay').classList.add('hidden');
        } catch (err) { document.getElementById('load-status').innerText = "åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"; }
    };

    function parseCSV(text) {
        const rows = text.split(/\r?\n/).filter(line => line.trim() !== "");
        plotLibrary = rows.slice(1).map(row => {
            const c = row.split(',');
            if (c.length < 32) return null;
            return {
                rank: c[1].trim(), title: c[4], text: c[5],
                choices: [
                    { 
                        text: c[6], checkAttr: c[7], checkVal: parseInt(c[8]), resOk: c[9], resFail: c[10],
                        stats: { beauty: +c[11], talent: +c[12], wit: +c[13], body: +c[14], prestige: +c[15], favor: +c[16] },
                        newRank: c[17].trim(), isBedtime: parseInt(c[18]) || 0
                    },
                    { 
                        text: c[19], checkAttr: c[20], checkVal: parseInt(c[21]), resOk: c[22], resFail: c[23],
                        stats: { beauty: +c[24], talent: +c[25], wit: +c[26], body: +c[27], prestige: +c[28], favor: +c[29] },
                        newRank: c[30].trim(), isBedtime: parseInt(c[31]) || 0
                    }
                ]
            };
        }).filter(i => i);
    }

    function generateIdentity() {
        const nameInput = document.getElementById('p-name').value;
        if (!nameInput) return alert("è¯·å…ˆèµå");
        p.name = nameInput;
        p.dynasty = DYNASTIES[Math.floor(Math.random() * 10)];
        p.startYear = Math.floor(Math.random() * 20) + 1;
        p.emperorDeathYear = Math.floor(Math.random() * 6) + 30; // 30-35å¹´
        p.rank = "ç­”åº”"; // åˆå§‹å›ºå®š
        p.stats = { beauty: 50, talent: 50, wit: 50, body: 60, prestige: 10, favor: 5 };
        
        document.getElementById('page-start').classList.add('hidden');
        document.getElementById('page-game').classList.remove('hidden');
        document.getElementById('menu-trigger').classList.remove('hidden');
        updateStatPanel();
        showPlot();
    }

    function updateStatPanel() {
        let curY = p.startYear + p.gameYear - 1;
        document.getElementById('stat-content').innerHTML = `
            <div class="stat-row">ä½ä»½ï¼š${p.rank}</div>
            <div class="stat-row">æ—¶é—´ï¼š${p.dynasty}${curY}å¹´ (${p.quarter}å­£)</div>
            <div class="stat-row">å­å—£ï¼š${p.children.son}ç”· ${p.children.daughter}å¥³</div>
            <div class="stat-row">åœ£å® ï¼š${p.stats.favor} | å£°æœ›ï¼š${p.stats.prestige}</div>
            <div class="stat-row">ä½“è´¨ï¼š${p.stats.body} | å¿ƒæœºï¼š${p.stats.wit}</div>
        `;
    }

    function showPlot() {
        let curY = p.startYear + p.gameYear - 1;
        if (curY >= p.emperorDeathYear) { handleEmperorDeath(); return; }

        let candidates = plotLibrary.filter(item => item.rank === p.rank);
        let s = candidates[Math.floor(Math.random() * candidates.length)] || { title: "æ·±å®«ç‹¬å", text: "è¿™ä¸€å­£æ— äº‹å‘ç”Ÿã€‚", choices: [{ text: "ç»§ç»­", resOk: "å…‰é˜´ä¼¼ç®­ã€‚", stats: {} }] };

        document.getElementById('story-text').innerHTML = `<strong>ã€${s.title}ã€‘</strong><br>${s.text}`;
        const area = document.getElementById('choices-area'); area.innerHTML = "";
        
        s.choices.forEach(c => {
            if(!c.text) return;
            let btn = document.createElement('button'); btn.className = "choice-btn"; btn.innerText = c.text;
            btn.onclick = () => {
                let pass = true;
                if(c.checkAttr && c.checkAttr !== "æ— ") {
                    const attrKey = {"å®¹è²Œ":"beauty","æ‰æƒ…":"talent","å¿ƒæœº":"wit","ä½“è´¨":"body","å£°æœ›":"prestige","åœ£å® ":"favor"}[c.checkAttr];
                    if(p.stats[attrKey] < c.checkVal) pass = false;
                }
                
                if(pass) {
                    for(let k in c.stats) p.stats[k] += c.stats[k];
                    
                    // --- æ ¸å¿ƒï¼šä¾å¯å­•è‚²é€»è¾‘ ---
                    if (p.rank !== "å®«å¥³" && c.isBedtime === 1) {
                        let prob = 0.3; // ä¸­ç­‰30%
                        if (p.stats.favor > 80 && p.stats.body > 70) prob = 0.5; // é«˜50%
                        else if (p.stats.favor < 30 || p.stats.body < 30) prob = 0.15; // ä½15%
                        
                        if (Math.random() < prob) {
                            if (Math.random() > 0.5) { p.children.son++; alert("ã€å–œè„‰ã€‘ä¾å¯æ‰¿æ©åï¼Œä½ è¯ä¸‹äº†çš‡å­ï¼"); }
                            else { p.children.daughter++; alert("ã€å–œè„‰ã€‘ä¾å¯æ‰¿æ©åï¼Œä½ è¯ä¸‹äº†å…¬ä¸»ï¼"); }
                            p.stats.prestige += 15;
                        }
                    }

                    if(c.newRank) p.rank = c.newRank;
                    p.quarter++; if(p.quarter > 4){ p.quarter = 1; p.gameYear++; }
                    updateStatPanel();
                    document.getElementById('story-text').innerHTML = `<div class="message">${c.resOk}</div>`;
                    area.innerHTML = `<button class="choice-btn" onclick="showPlot()">ç»§ç»­</button>`;
                } else {
                    gameOver(c.resFail || "è®¡è°‹è´¥éœ²ï¼Œé­‚å½’å¹½å†¥ã€‚");
                }
            };
            area.appendChild(btn);
        });
    }

    function handleEmperorDeath() {
        const { rank, children, stats } = p;
        let title = "å¤§è¡Œçš‡å¸é©¾å´©", msg = "ä½™ç”Ÿå·²å®šã€‚";

        // ç»“å±€åˆ¤å®šå¼•æ“ (æ•´åˆç”¨æˆ·æä¾›çš„å…¨éƒ¨ç»“å±€åˆ†æ”¯)
        if (rank.includes("çš‡å")) {
            if (children.son > 0) {
                if (stats.wit > 80) { title="åœ£æ¯çš‡å¤ªå"; msg="å«¡å­ç™»åŸºï¼Œä½ å‚å¸˜å¬æ”¿ï¼Œè¾…ä½æ–°å¸å¼€åˆ›ç››ä¸–ã€‚"; }
                else { title="å®ˆå›½æ‰˜å­¤"; msg="çš‡å­å¹´å¹¼ï¼Œä½ ä¸´å±å—å‘½ç¨³å®šæœå±€ï¼Œå‹åˆ¶æƒè‡£ã€‚"; }
            } else {
                if (stats.prestige > 80) { title="ç»§åå°Šè£"; msg="æ–°å¸å°Šä½ ä¸ºæ¯åçš‡å¤ªåï¼Œä½å±…ç”Ÿæ¯ä¹‹ä¸Šã€‚"; }
                else { title="å®«æ–—åå™¬"; msg="å¤ºå«¡ç«™é”™é˜Ÿï¼Œè¢«åºŸé»œè´¬ä¸ºåº¶äººå›šç¦é™µå¯ã€‚"; }
            }
        } 
        else if (rank === "è´µå¦ƒ") {
            if (children.son > 0) {
                if (stats.wit > 90) { title="å¤ªåå°Šè£"; msg="å„¿å­æˆåŠŸç™»åŸºï¼Œä½ å…¥ä¸»æ…ˆå®å®«ã€‚"; }
                else { title="å”å«‚ç›¸å®‰"; msg="çš‡å­æœªåŠå¤§ç»Ÿï¼Œä½ éšå­å‰å¾€å°åœ°å®‰ç¨³åº¦æ—¥ã€‚"; }
            } else {
                if (stats.prestige > 90) { title="æ‘„æ”¿è¾…å›½"; msg="æ·±å¾—å…ˆå¸ä¿¡ä»»ï¼Œä½ è¾…ä½æ–°å¸ç¨³å®šæœå±€ï¼Œåç•™é’å²ã€‚"; }
                else { title="å¤±åŠ¿è½å¯"; msg="ä¸æ–°å¸ç”Ÿæ¯ä¸åˆï¼Œè¢«è¿å±…åè¿œå®«æ®¿ï¼Œæ™šæ™¯å‡„å‡‰ã€‚"; }
            }
        }
        else if (rank === "å¦ƒ") {
            if (children.son > 0) {
                if (stats.prestige > 70) { title="è¾…æ”¿å¤ªå¦ƒ"; msg="çš‡å­ä¸ºæ–°å¸è‡‚è†€ï¼Œä½ è¢«å°çš‡è€ƒè´µå¦ƒï¼Œå¨ä»ªæé«˜ã€‚"; }
                else { title="å°åœ°è‡³å°Š"; msg="éšäº²ç‹å‰å¾€å°åœ°ï¼Œå°½äº«è£åå¯Œè´µã€‚"; }
            } else {
                if (stats.wit > 80) { title="æ¿€æµå‹‡é€€"; msg="è¯·æ—¨å‰å¾€çš‡å®¶åˆ«é™¢ï¼Œé—²äº‘é‡é¹¤åº¦æ­¤ä½™ç”Ÿã€‚"; }
                else { title="å¾·é«˜æœ›é‡"; msg="æ–°å¸æ„Ÿå¿µä½ è´¤è‰¯ï¼Œå°Šä¸ºå¤ªå¦ƒï¼Œåœ¨å®«ä¸­é¢å…»å¤©å¹´ã€‚"; }
            }
        }
        else if (rank === "è´µäºº") {
            if (children.son > 0) {
                if (stats.wit > 70) { title="çš‡å­æˆæ‰"; msg="çš‡å­è·å°äº²ç‹ï¼Œä½ åœ¨è¯·å®‰ä¸äº²æƒ…ä¸­åº¦è¿‡ã€‚"; }
                else { title="å¤ºå«¡è½è´¥"; msg="çš‡å­è¢«æµæ”¾ï¼Œä½ è¢«å‰¥å¤ºå°å·ç¦è¶³åœ¨å†·å®«ã€‚"; }
            } else if (children.daughter > 0) {
                title="å…¬ä¸»å’Œäº²"; msg="å¥³å„¿è¢«é€å¾€å’Œäº²ï¼Œä½ åœ¨æ€å¿µä¸­è€å»ã€‚";
            } else {
                title="ä½›å ‚æ¸…ä¿®"; msg="ä¸»åŠ¨å¸¦å‘ä¿®è¡Œï¼Œé’ç¯å¤ä½›ï¼Œä¼´é’Ÿå£°è€Œé€ã€‚";
            }
        }
        else { // ç­”åº”
            if (children.son > 0) {
                if (stats.prestige > 50) { title="å°åœ°ä¼´é©¾"; msg="ç‹åºœå¤ªå¦ƒã€‚è¿œç¦»çº·äº‰ï¼Œæ‹¥æœ‰å¯»å¸¸å¦‡äººçš„å®‰ç¨³ã€‚"; }
                else { title="å¯„å­ä½™ç”Ÿ"; msg="å®‰ç½®åœ¨åˆ«è‹‘ï¼Œæ¯æ—¥ç„šé¦™ä¸ºå­ç¥ˆç¦ã€‚"; }
            } else {
                if (stats.beauty > 70) { title="å‡ºå®«å½’å®¶"; msg="æ–°å¸èµ¦å…ï¼Œä½ å½’äºæ°‘é—´å«ä½œå‡¡äººå¦‡ã€‚"; }
                else { title="å®ˆé™µç»ˆè€"; msg="å‰å¾€çš‡é™µä¸ºå…ˆå¸å®ˆçµï¼Œæ¸…å†·è€—å°½ä½™ç”Ÿã€‚"; }
            }
        }
        showEnding(title, msg);
    }

    function showEnding(title, msg) {
        document.getElementById('page-game').innerHTML = `
            <div class="end-card">
                <h2 style="color:var(--palace-red);">${title}</h2>
                <div style="line-height:1.7;">${msg}</div>
                <button class="choice-btn" style="margin-top:20px;" onclick="location.reload()">å†å…¥è½®å›</button>
            </div>`;
    }

    function gameOver(res) {
        document.getElementById('page-game').innerHTML = `
            <div class="dead-card"><h2>é­‚æ–­æ·±å®«</h2><p>${res}</p><button class="choice-btn" onclick="location.reload()">é‡æ–°å¼€å§‹</button></div>`;
    }

    function toggleStats() { document.getElementById('stat-panel').classList.toggle('open'); }
    function resistDecree() { gameOver("æŠ—æ—¨ä¸å°Šæ˜¯å¤§ç½ªï¼Œä½ è¢«èµæ­»ã€‚"); }
</script>
</body>
</html>
